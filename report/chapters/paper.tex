\chapter{Hyland's paper}


\section{Scott's Representation Theorem}
\begin{theorem}\label{thm:representation-theorem}
  Any $ \lambda $-theory $ L $ is isomorphic to the endomorphism $ \lambda $-theory $ E(L) $ of $ L: \Pshf L $, which is $ L $, viewed as a presheaf in its own presheaf category.
\end{theorem}
\begin{proof}
  First of all, remember that $ L $ is indeed exponentiable and that $ L^L = A(L, 1) $.
  Now, since $ L $ is a $ \lambda $-theory, we have sequences of functions back and forth $ \lambda_n: A(L, 1)_n \to L_n $ and $ \rho_n: L_n \to A(L, 1)_n $. These commute with the $ L $-actions, so they constitute presheaf morphisms and $ E(L) $ is indeed a $ \lambda $-theory.

  Lemma \ref{lem:presheaf-Yoneda} gives a sequence of bijections $ \varphi_n : \Pshf L(L^n, L) \cong L_n $ for all $ n $, sending $ F: \Pshf L(L^n, L) $ to $ F(x_1, \dots, x_n) $, and conversely sending $ s: L_n $ to $ ((t_1, \dots, t_n) \mapsto s \bullet (t_1, \dots, t_n)) $. It considers $ \lambda $-terms in $ n $ variables as $ n $-ary functions on the $ \lambda $-calculus. Therefore, it should come as no surprise that $ \varphi $ preserves the $ x_i $, $ \bullet $, $ \rho $ and $ \lambda $, which makes it into an isomorphism of $ \lambda $-theories and this concludes the proof.
\end{proof}

\section{Relations between the categories}

As mentioned before, we have a fully faithful embedding of $ \R $ into $ \Pshf L $.

Also, we have a functor from the Lawvere Theory $ \mathbf{L} $ (see Lemma \ref{lem:lawvere-clone}) associated to $ L $ into $ \R $, sending $ n : \mathbf L $ to $ U^n : \R $. By Scott's representation theorem, this functor can map morphisms as follows:
\[ \mathbf L(m, n) = L_m^n \cong \R(U^m, U)^n \cong \R(U^m, U^n), \]
which immediately shows that this functor is a fully faithful embedding.

Note that if we consider $ L_1 $ as a monoid, with operation $ \bullet $ and unit $ x_1 $, and if we consider this monoid as a category, we can embed this (fully faithfully) into $ \mathbf L $. This gives the following sequence of embeddings:
\begin{center}
  \begin{tikzcd}
    L_1 \arrow[r, hookrightarrow] & \mathbf L \arrow[r, hookrightarrow] & \R \arrow[r, hookrightarrow] & \Pshf L
  \end{tikzcd}
\end{center}

Note that the composition of the first two morphisms sends the object of the category $ L_1 $ to $ (\lambda x_1, x_1) : \R $, which is exactly the usual embedding of $ L_1 $ into its Karoubi envelope.

Write $ i: \op{L_1} \hookrightarrow \op{\mathbf L} $ and $ j: \op{\mathbf L} \hookrightarrow \op \R $ for the embeddings on the opposite categories. By Corollary \ref{cor:surjective-precomposition}, the first two morphisms in this sequence yield the following sequence of essentially surjective functors on the presheaf categories:
\begin{center}
  \begin{tikzcd}
    \mathbf R \arrow[r, hookrightarrow] \arrow[d, hookrightarrow, "Y"] & \Pshf L \arrow[d, "\sim"]\\
    P \R \arrow[r, twoheadrightarrow, "j_*"] \arrow[rr, bend right, "\sim"] & P \mathbf L \arrow[r, twoheadrightarrow, "i_*"] & P C_{L_1}
  \end{tikzcd}
\end{center}
The two equivalences in this diagram are due to Lemma \ref{lem:lawvere-presheaf} and Corollary \ref{cor:karoubi-presheaf}.

\begin{lemma}\label{lem:equivalent-presheaf-cats}
  The precomposition functors $ i_* $ and $ j_* $ are adjoint equivalences.
\end{lemma}
\begin{proof}
  We will show that $ j_* $ is an adjoint equivalence. From the `two out of three' property, it follows then that $ i_* $ is also an adjoint equivalence.

  Lemma \ref{lem:lan-precomp-iso} shows that $ \eta: \id{P \mathbf L} \Rightarrow \Lan j {} \bullet j_* $ is a natural isomorphism. To complete the proof that $ j_* $ is an adjoint equivalence, we just have to show that $ \epsilon: j_* \bullet \Lan j {} \Rightarrow \id{P \mathbf L} $ is a natural isomorphism as well.

  To this end, take $ F : P \R $. By Lemma \ref{lem:lan-precomp-iso}, we have the isomorphism
  \[ \eta^{-1}_{j_* F}: j_* (\Lan j (j_* F)) \cong j_* F. \]
  Since functors preserve isomorphisms, we have $ i_* (j_* (\Lan j (j_* F))) \cong i_* (j_* F) $. However, since $ j_* \bullet i_* $ is an equivalence and in particular fully faithful, this corresponds to an isomorphism
  \[ \Lan j (j_* F) \cong F. \]
  Now we only need to prove that its morphism is equal to $ \epsilon_F $. Equivalently, we need to prove that $ i_* (j_* \epsilon) $ is equal to the morphism $ i_* \eta_{j_* F}^{-1} $, or that $ j_* \epsilon $ equals $ \eta^{-1}_{j_* F} $.

  Take $ n : \mathbf L $. We need to show that $ \epsilon_F (j(n)) = \eta_{j_* F}^{-1}(n) $ as functions from $ (\Lan j {} (j_* F)) (j(n)) $ to $ F(j(n)) $. Note that the diagram for $ (\Lan j {} (j_* F)) (j(n)) $ consists of $ F(j(m)) $ for all $ f: \R(j(m), j(n)) $. Now, as it turns out, both $ \epsilon_F (j(n)) $ and $ \eta_{j_* F}^{-1}(n) $ are defined as the colimit arrow of $ F(f) : \SET(F(j(m)), F(j(n))) $ for all $ f: \R(j(m), j(n)) $, which concludes the proof.
\end{proof}

\begin{lemma}
  The square in the diagram above 2-commutes.
\end{lemma}
\begin{proof}
  Note:
  \[ (Y \bullet j_*)(A)(n) = (j \bullet (Y(A)))(n) = Y(A)(j(n)) = \R(U^n, A) \]
  \[ (\iota \bullet \sim)(A)(n) = \{ a : L_n \mid \iota_{0, n}(A) a = a \} \]

  By Scott's representation theorem, we have $ \varphi_n: \R(U^n, U) \xrightarrow \sim L_n, $ given by
  \[ \varphi_n(f) = \iota_{0, n}(f) ((((c, x_1), x_2), \dots), x_n). \]
  Restricting this equivalence to the morphisms to $ A $ yields
  \[ \R(U^n, A) \cong \{ a : L_n \mid A a = a \}. \]
  Of course, this is natural in $ A $, since for $ g: \R(A, B) $, postcomposing elements of $ \R(U^n, A) $ by $ g $ is equivalent to applying $ g $ to the elements of $ \{ a : L_n \mid A a = a \} $.

  Lastly, for $ f : L_m^n $, the presheaf actions
  \[ (Y \bullet j_*)(A)(f) : \R(U^n, A) \to \R(U^m, A) \]
  and
  \[ (\iota \bullet \sim)(A)(f) : \{ a : L_n \mid \iota_{0, n}(A) a = a \} \to \{ a : L_m \mid \iota_{0, n}(A) a = a \} \]
  are in fact given by the substitution operations $ \bullet $ in $ E(U) $ and $ L $. Since Scott's representation theorem shows that $ E(U) $ is isomorphic to $ L $ as a $ \lambda $-theory, these substitutions are compatible with the $ \varphi_n $, which shows naturality in $ n $.
\end{proof}

\section{Locally cartesian closedness of the category of retracts}

Recall that Paul Taylor constructed a category of `dependent retracts' $ \R^A $, and then defined a class of display maps for $ \R $ in such a way that it gives a weak equivalence $ \sum_A : \R^A \xrightarrow{\sim} (\R \downarrow_D A) $. I.e., a map $ f: \R(X, A) $ is defined to be a display map if it is isomorphic to something in the image of the functor $ \sum_A $. We saw that these display maps can also be characterized as the retracts of the projection $ p_1: A \times U \to A $ in $ (\R \downarrow A) $.

Now, noticing that we can embed $ \R $ as a full subcategory in $ \Pshf L $, Hyland attempts to do a similar thing for $ \Pshf L $. Noting that the universal object $ U : \R $ is embedded as the theory presheaf $ L : \Pshf L $, he defines a full subcategory $ \R(A) \subseteq (\Pshf L \downarrow A) $, consisting precisely of the retracts of $ \Delta_A L $ in $ (\Pshf L \downarrow A) $.

\begin{remark}
  Again, being a retract of $ \Delta_A L $ is not a mere proposition. For example, consider $ \id L : D(L, L) $:
  \begin{center}
    \begin{tikzcd}
      L \arrow[rr, shift left, "s"] \arrow[rd, "\id L"'] & & L \times L \arrow[ll, shift left, "r"] \arrow[ld, "p_1"]\\
      & L
    \end{tikzcd}
  \end{center}
  There are multiple possible retraction-section pairs $ (r, s) $ that make the diagram commute. For example, we can take $ s $ to be the diagonal embedding $ \Delta : L \to L \times L $ (sending $ l $ to $ (l, l) $). Then we can take $ r = p_1 $ or $ r = p_2 $. We can also take $ r = \pi_1 $ and $ s = \langle \id L, g \rangle $ the product morphism of $ \id L $ and any (possibly constant) endomorphism $ g: L \to L $.

  Therefore, we need to take the propositional truncation of the existence of $ r $ and $ s $.
\end{remark}

\begin{remark}
  Taylor would write $ (\Pshf L \downarrow_D A) $ instead of $ \R(A) $, with $ D(X, A) $ the retracts $ f: X \to A $ of $ \Delta_A L $. However, note that $ D $ is not a class of display maps. For example, for $ D $ to be a class of display maps, all terminal projections $ ! : X \to T $ need to be in $ D $. Since for any category $ C $ with terminal object $ T $, we have an equivalence $ (C \downarrow T) \cong C $, having all terminal projections in $ D $ is equivalent to every object in $ \Pshf L $ being a retract of $ L $.

  However, if we take $ X $ to be the initial (empty) presheaf, we see that there are no morphisms $ L \to X $, because the $ L_n $ are nonempty and the $ X_n $ are empty.

  There also is a more category-theoretical argument: Suppose that every object of $ \Pshf L $ is a retract of $ L $. Via the equivalence $ \Pshf L \cong L_1 $, we see that every object of $ P C_{L_1} $ is a retract of $ Y(\star) $. However then the embedding of $ \hat \R $ (Definition \ref{def:karoubi'}) into $ P C_{L_1} $ is an adjoint equivalence. Since $ Y_{\R} \bullet {\op{\iota_{L_1}}}_* : \R \to \hat \R $ and $ {\op{\iota_{L_1}}}_* : P \R \to P C_{L_1} $ are weak equivalences, (Lemma \ref{lem:retracts-rezk}, Corollary \ref{cor:karoubi-presheaf}), $ Y_\R : \R \to P \R $ is a weak equivalence as well, but the Yoneda embedding is never essentially surjective. For any category $ C $, the constant empty presheaf $ E: c \mapsto \emptyset $ is not representable, since for all $ c : C $, $ \id c = Y(c)(c) $, so $ Y(c) $ is not isomorphic to $ E $.
\end{remark}

Recall that $ \Pshf L $ is isomorphic to the presheaf category $ P \mathbf L $, so it is an elementary topos, so it is locally cartesian closed (Example 5.2.5 and Theorem 5.8.4, \cite{borceux}, Volume 3). Therefore, for a morphism $ f: \Pshf L(Y, X) $, we have adjunctions
\begin{center}
  \begin{tikzcd}
    (\Pshf L \downarrow X) \arrow[r, "f^*"' description, ""{name=B}] & (\Pshf L \downarrow Y) \arrow[l, bend right, "{\sum_f = - \cdot f}"'{name=A}] \arrow[l, bend left, "\prod_f"{name=C}]
    \arrow[from=A, to=B, symbol=\dashv]
    \arrow[from=B, to=C, symbol=\dashv]
  \end{tikzcd}
\end{center}

Now, Hyland shows the following:
\begin{theorem}\label{thm:restrict-sum-product}
  For $ (Y, f) : \R(X) $, we can restrict $ \sum_f $ and $ \prod_f $ to functors from $ \R(Y) $ to $ \R(X) $.
\end{theorem}
\begin{proof}
  This proof proceeds by reducing, step by step, to a known case.

  We take $ (Z, g) : \R(Y) $. Since functors preserve retraction-section pairs, $ \prod_f(Z, g) $ is a retract of $ \prod_f \Delta_Y L $. Now, if this is a retract of $ \Delta_X L $, then $ \prod_f(Z, g) $ is a retract of $ \Delta_X L $ as well: We can just compose retractions and sections. Therefore, to show that the image of $ \R(Y) $ under $ \prod_f $ lies within $ \R(X) $, we just need to show that $ \prod_f \Delta_Y L $ lies in $ \R(X) $. In the same way, for $ \sum_f $ we just need to show that $ \sum_f \Delta_Y L $ lies in $ \R(X) $.

  By the definition of $ \R(X) $, $ (Y, f) $ is a retract:
  \begin{center}
    \begin{tikzcd}
      Y \arrow[rd, "f"'] \arrow[r, "s"] & X \times L \arrow[d, "p_1"] \arrow[r, "r"] & Y \arrow[ld, "f"]\\
      & X
    \end{tikzcd}
  \end{center}

  The counits of the adjunctions $ r_* \vdash \prod_r $ and $ s_* \vdash \prod_s $, give maps
  \[
    \prod_f \Delta_Y L \xrightarrow{\prod_f \eta_r}
    \prod_f \prod_r r^* \Delta_Y L \xrightarrow{\prod_f \prod_r \eta_s}
    \prod_f \prod_r \prod_s s^* r^* \Delta_Y L
  \]
  Their composite is $ \prod_f \eta_{s \cdot r} $. However, note that $ r \cdot s = \id Y $, so we have an isomorphism of functors
  \[ (s \cdot r)^* \cong \id{\Pshf L \downarrow Y} \quad \text{and} \quad \prod_{s \cdot r} \cong \id{\Pshf L \downarrow Y} \]
  and transporting $ \eta_{s \cdot r} $ along these isomorphisms, we get the identity natural transformation $ \id{\Pshf L \downarrow Y} \Rightarrow \id{\Pshf L \downarrow Y} $.

  Secondly, note that $ r \cdot f = p_1 $, so we have $ \prod_r \bullet \prod_f \cong \prod_{p_1} $.

  Lastly, by Remark \ref{rem:pullback-of-projection}, $ r^* \Delta_Y L \cong \Delta_{X \times L} L $.

  Therefore, we have the following diagram, showing that $ \prod_f \Delta_Y L $ is a retraction of $ \prod_{p_1} \Delta_{X \times L} L $:
  \begin{center}
    \begin{tikzcd}
      & \prod_{p_1} \Delta_{X \times L} L\\
      \prod_f \Delta_Y L
        \arrow[r, "\prod_f \eta_r"]
        \arrow[rr, bend right, "\prod_f \eta_{s \cdot r}"]
        \arrow[rrr, bend right, "\id {\Pshf L \downarrow X}"] &
      \prod_f \prod_r r^* \Delta_Y L \arrow[r, "\prod_f \prod_r \eta_s"] \arrow[u, "\sim"] &
      \prod_f \prod_r \prod_s s^* r^* \Delta_Y L \arrow[r, "\sim"] &
      \prod_f \Delta_Y L
    \end{tikzcd}
  \end{center}
  In a similar way, $ \sum_f \Delta_Y L $ is a retract of $ \sum_{p_1} \Delta_{X \times L} L $:
  \begin{center}
    \begin{tikzcd}
      & & \sum_{p_1} \Delta_{X \times L} L \\
      \sum_f \Delta_Y L
        \arrow[r, "\sim"]
        \arrow[rrr, bend right, "\id {\Pshf L \downarrow X}"] &
      \sum_f \sum_r \sum_s s^* r^* \Delta_Y L
        \arrow[r, "\sum_f \sum_r \epsilon_s"]
        \arrow[rr, bend right, "\sum_f \epsilon_{s \cdot r}"] &
      \sum_f \sum_r r^* \Delta_Y L
        \arrow[u, "\sim"]
        \arrow[r, "\sum_f \epsilon_r"] &
      \sum_f \Delta_Y L
    \end{tikzcd}
  \end{center}
  So again, by the transitivity of retracts, we only have to show that $ \prod_{p_1} \Delta_{X \times L} L $ and $ \sum_{p_1} \Delta_{X \times L} L $ are retracts of $ \Delta_X L $. By Lemma \ref{lem:constant-dependent-product}, we have $ \prod_{p_1} \Delta_{X \times L} L \cong \Delta_X L^L $. By Lemma \ref{lem:sum-postcomposition}, the functor $ \sum_{p_1} $ is given by postcomposition, so $ \sum_{p_1} \Delta_{X \times L} L \cong \Delta_X (L \times L) $.

  Since $ \Delta_X $ is a functor, and in particular, preserves retracts, we only have to show that $ L \times L $ and $ L^L $ are retracts of $ L $.

  But we already saw in Theorem \ref{thm:representation-theorem} that $ L^L \cong A(L, 1) $ is a retract of $ L $.

  Also, the (pairing and splitting) morphisms $ s: \Pshf L(L \times L, L) $ and $ r: \Pshf L(L, L \times L) $ given by
  \[ s_n(a, b) = \lambda x_{n + 1}, x_{n + 1} a b \quad \text{and} \quad r_n(a) = (a (\lambda x_{n + 1} x_{n + 2}, x_{n + 1}), a (\lambda x_{n + 1} x_{n + 2}, x_{n + 2})) \]
  exhibit $ L \times L $ as a retract of $ L $.
\end{proof}

\begin{remark}
  Now, recall that according to Hyland, Taylor endows the category of retracts $ \R $ with a class of display maps $ D $, such that $ (\R \downarrow_D X) $ consists exactly of the retracts of $ \Delta_X U $.

  Hyland then claims that the fact that $ \R $ is cartesian closed relative to this class of display maps follows from the theorem above. Recall that Taylor already shows relative cartesian closedness directly, which still works in univalent foundations if we assume the axiom of choice.

  Recall that we have a weak equivalence $ \varphi : \R \xrightarrow \sim \hat \R $ (Lemma \ref{lem:retracts-rezk}) and one can imagine that we can extend this to weak equivalences $ \psi_X : (\R \downarrow_D X) \xrightarrow \sim (\hat \R \downarrow_D \varphi(X)) $. Hyland notes that for $ X : \hat \R $, $ \R(\varphi(X)) $ is equivalent to $ (\hat \R \downarrow_D \varphi(X)) $. Implicitly, for $ f: \R(X, Y) $, he wants to lift the functors $ \sum_f $, $ f^* $ and $ \prod_f $ along the equivalences $ \psi $:
  \begin{center}
    \begin{tikzcd}[column sep = .5in, row sep = .5in]
      (\R \downarrow_D X)
        \arrow[d, "\psi_X"]
        \arrow[r, dashed, bend left, "\sum_f"']
        \arrow[r, dashed, bend right, "\prod_f"]
      & (\R \downarrow_D Y)
        \arrow[d, "\psi_Y"]
        \arrow[l, dashed, "f^*" description]\\
      \R(\varphi(X))
        \arrow[r, bend left, "\sum_{\varphi(f)}"']
        \arrow[r, bend right, "\prod_{\varphi(f)}"]
      & \R(\varphi(Y))
        \arrow[l, "\varphi(f)^*" description]\\
    \end{tikzcd}
  \end{center}
  For this to work, we need to turn the weak equivalences $ \psi_X $ into adjoint equivalences. In particular, we know that for every object $ A : \R(\varphi(X)) $, there merely exists a preimage $ \bar A : (\R \downarrow_D X) $ such that $ \psi_X(\bar A) \cong A $, and we need to construct a functor $ \psi_X^{-1}: \R(\varphi(X)) \to (\R \downarrow_D X) $.

  For Taylor's proof, we did a similar thing when we knew that for every object $ X : (\R \downarrow_D A) $, there existed some $ Y : \R^A $, and we needed to construct a pullback functor $ f^* : (\R \downarrow_D A) \to (\R \downarrow_D B) $. We could use the axiom of choice here because the objects of $ \R $ (and therefore also the objects of the relative slices $ (\R \downarrow_D A) $) form a set.

  However, as mentioned in \cite{univalent-categories} halfway through the introduction, and as explained more thoroughly in \cite{hottbook}, Lemma 3.8.5, if $ \R(\varphi(X)) $ is not a set (and if $ L $ is nontrivial, it is never a set), then there is no axiom of choice which can turn the `for all \dots, there exists \dots' into a `there exists a function'.

  Therefore, in univalent foundations, the relative cartesian closedness is not a corollary of Theorem \ref{thm:restrict-sum-product}.
\end{remark}

\section{Terms of a \texorpdfstring{$ \Lambda $}{Lambda}-algebra}
Let $ A $ be an algebra for the initial $ \lambda $-theory $ \Lambda $. We will assume that $ \Lambda $ (and therefore, any $ \lambda $-theory) satisfies $ \beta $-equality.

The $ \Lambda $-algebra structure gives the terms of $ A $ quite a lot of behaviour. For example, we can define `function application' as
\[ a b = (x_1 x_2) \bullet (a, b) \]
and composition as
\[ a \circ b = (x_1 \circ x_2) \bullet (a, b) \]
and the same for the other constructions at the start of Section \ref{sec:retracts-category}.

\begin{remark}
  Recall that in Example \ref{ex:free-monoid-theory}, we constructed an algebraic theory $ T $ with a monoid structure. This allowed us to define a monoid operation on $ T $-algebras as well. We then were able to transfer associativity of the operation on the $ T_n $ to associativity of the operation on the algebras. In exactly the same way, the function composition on $ A $ is associative because composition on $ \Lambda_n $ is associative.
\end{remark}

\begin{definition}
  We can consider the sets of elements of $ A $ that behave like functions in $ n $ variables:
  \[ A_n = \{ a : A \mid (\lambda x_2 x_3 \dots x_{n + 1}, x_1 x_2 x_3 \dots x_{n + 1}) \bullet a = a \}. \]
\end{definition}

\begin{definition}
  Take $ \mathbf 1_n = (\lambda x_1 \dots x_n, x_1 \dots x_n) \bullet () : A $.
\end{definition}

\begin{remark}
  Some straightforward rewriting, shows that for all $ a : A $,
  \[ \mathbf 1_n \circ a = (\lambda x_2 x_3 \dots x_{n + 1}, x_1 x_2 \dots x_{n + 1}) \bullet a. \]
  In other words, $ A_n = \{ a : A \mid \mathbf 1_n \circ a = a \} $.
\end{remark}

\begin{remark}
  Also note that $ \mathbf 1_n \circ a \circ \mathbf 1_n = \mathbf 1_n \circ a $, so for $ a : A_n $, $ a \circ \mathbf 1_n = a $.
\end{remark}

\begin{lemma}
  For $ t: \Lambda_{m + n} $ and $ a_1, \dots, a_m: A $, we have $ (\lambda^n t) \bullet (a_1, \dots, a_m) : A $ and we have
  \[ \mathbf 1_n \circ ((\lambda^n t) \bullet (a_1, \dots, a_m)) = (\lambda^n t) \bullet (a_1, \dots, a_m), \]
  so $ (\lambda^n t) \bullet (a_1, \dots, a_m) : A_n $.
\end{lemma}
\begin{proof}
  This follows by straightforward rewriting.
\end{proof}

\begin{corollary}
  By the previous remark,
  \[ ((\lambda^n t) \bullet (a_1, \dots, a_m)) \circ \mathbf 1_n = (\lambda^n t) \bullet (a_1, \dots, a_m). \]
\end{corollary}
\begin{corollary}
  In particular, $ \mathbf 1_m \circ \mathbf 1_n = \mathbf 1_{\max(m, n)} $. From this, it follows that $ A_m \subseteq A_n $ for $ m \leq n $. It also follows that $ a \mapsto \mathbf 1_n \circ a $ gives a function from $ A $ to $ A_n $ (and also from $ A_m \subseteq A $ to $ A_n $).
\end{corollary}


\section{The Fundamental Theorem of the \texorpdfstring{$ \lambda $-}{lambda }calculus}

The fundamental theorem states that there is an adjoint equivalence
\[ \LamTh \cong \Alg \Lambda. \]
We will prove this by showing that there is a weak equivalence. Using the fact that $ \LamTh $ is


\subsection{The functor}

\begin{definition}
  For all $ n $, we have a functor from lambda theories to $ \Lambda $-algebras. It sends the $ \lambda $-theory $ L $ to the $ L $-algebra $ L_n $ and then turns this into a $ \Lambda $-algebra via the morpism $ \Lambda \to L $. It sends morphisms $ f: L \to L^\prime $ to the algebra morphism $ f_n : L_n \to L^\prime_n $.
\end{definition}

Here, we are mostly interested in the case $ n = 0 $.

\subsection{Lifting \texorpdfstring{$ \Lambda $}{Lambda}-algebras}

\begin{definition}[The monoid of a $ \Lambda $-algebra]
  We make $ A_1 $, the `functional elements' of $ A $, into a monoid under composition $ \circ $ with unit $ \mathbf 1_1 $. The fact that this is a monoid follows from the remarks in the last section.
\end{definition}

Recall that we have an equivalence $ [\op{C_{A_1}}, \SET] \cong \RAct{A_1} $.

In particular, we have a set with right $ A_1 $-action, given by $ A_1 $ itself. We will call this set with right $ A_1 $-action $ U_A $.

\begin{remark}
  Note that, like in the last chapter, we can take the Karoubi envelope $ \R_A $ of $ C_{A_1} $, which yields the following diagram:
  \begin{center}
    \begin{tikzcd}
      & C_{A_1} \arrow[d, hookrightarrow, "Y"] \arrow[r, hookrightarrow, "\iota_{C_{A_1}}"] & \R_A \arrow[d, hookrightarrow, "Y"]\\
      \RAct{A_1} & P C_{A_1} \arrow[l, "\sim"] & P \R_A \arrow[l, "\sim"]
    \end{tikzcd}
  \end{center}
  Explicitly, this gives the embedding $ \R_A(\mathbf 1_1, -): \R_A \hookrightarrow \RAct{A_1} $ given by
  \[ X \mapsto \R_A(\mathbf 1_1, X) = \{ x : A \mid X \circ x = x \}. \]
  Now, we can repeat almost the entirety of Section \ref{sec:retracts-category} for $ \R_A $. In particular, $ \R_A $ has "universal object"
  \[ U = \mathbf 1_1, \]
  products
  \[ A \times B = \langle x_1 \circ \pi_1, x_2 \circ \pi_2 \rangle \bullet (A, B) \]
  and exponential objects
  \[ B^A = (\lambda x_3, x_1 \circ x_3 \circ x_2) \bullet (B, A) \]
  with the isomorphism $ \psi: \R_A(C \times A, B) \xrightarrow \sim \R_A(C, B^A) $
  given by
  \[ \psi(f) = (\lambda x_2 x_3, x_1 (x_2, x_3)) \bullet f \quad \text{and} \quad \psi^{-1}(f) = (\lambda x_2, x_1 (\pi_1 x_2) (\pi_2 x_2)) \bullet f. \]
\end{remark}

\begin{remark}\label{rem:ract-presheaf-equivalence}
  Also, note that if $ A = L_0 $ for some $ \lambda $-theory $ L $, then the monoid $ A_1 $ is equivalent to the monoid $ L_1 $, and $ \R_A $ is equivalent to our familiar category of retracts $ \R $. From Lemma \ref{lem:equivalent-presheaf-cats}, it follows that $ \RAct{A_1} $ is equivalent to $ \Pshf L $. This might motivate some of the following constructions.
\end{remark}

\begin{definition}
  Composition $ \circ $ gives a right $ A_1 $-action on the $ A_n $, so we have $ A_n : \RAct{A_1} $ (note that this is the image of $ \mathbf 1_n : \R_A $ under the embeddding into $ \RAct{A_1} $).
\end{definition}

\begin{lemma}
  $ A_2 $ is the exponential object $ A_1^{A_1} $ in $ \RAct{A_1} $.
\end{lemma}
\begin{proof}
  Note that the embedding $ \R_A \hookrightarrow \RAct{A_1} $ is the composition of a Yoneda embedding and two adjoint equivalences. These all preserve exponential objects (\TODO: Citation needed). Since $ A_1 $ is the image of $ \mathbf 1_1 : \R_A $, the exponential $ A_1^{A_1} $ is $ A_2 $, the image of $ \mathbf 1_1^{\mathbf 1_1} = \lambda x_1 x_2, x_1 x_2 $.
\end{proof}

\begin{remark}
  Hyland shows this by explicitly constructing an isomorphism $ \psi $ between $ A_2 $ and the `familiar' exponential object in $ \RAct{A_1} $ (the set of $ A_1 $-equivariant morphisms $ U_A \times U_A \to U_A $), given by
  \[ \psi(f) = (b, b^\prime) \mapsto (\lambda x_4, x_1 (x_2 x_4) (x_3 x_4)) \bullet (f, b, b^\prime), \]
  treating $ f : A_2 $ as a function in two variables, and simultaneously composing it with the functions $ b, b^\prime : A_1 $. It has an inverse
  \[ \psi^{-1}(g) = (\lambda x_2 x_3, x_1 (x_2, x_3)) \bullet (g(\pi_1, \pi_2)). \]
  Note that the first pair $ (x_2, x_3) $ is a $ \lambda $-term, whereas the second pair $ (\pi_1, \pi_2) $ is a pair in $ U_A \times U_A $.
\end{remark}

\begin{definition}[Construction of the $ \lambda $-theory]
  Now, note that, like before, $ \mathbf 1_1 $ is a retract of $ \mathbf 1_2 $ in $ \R_A $. When we embed these into $ \RAct{A_1} $, we see that we have a subset $ A_2 \subseteq A_1 $ and a retraction $ r: A_1 \to A_2 $, given by precomposition with $ \mathbf 1_2 $.

  Therefore, $ \mathbf 1_1 $ and $ U_A $ are reflexive objects in $ \R_A $ and $ \RAct{A_1} $, and we get isomorphic $ \lambda $-theories $ E(\mathbf 1_1) $ and $ E(U_A) $.
\end{definition}

\subsection{Lifting algebra morphisms}

Now, take a morphism $ F: \Alg{\Lambda}(A, B) $. Recall that $ \circ $, the structure on $ \mathbf R_A $ and $ \mathbf R_B $, and their products and exponential objects are given by $ f \bullet (a_1, \dots, a_n) $ for some $ f: \Lambda_n $ and $ a_1, \dots, a_n : A $. Since we have $ F(f \bullet (a_1, \dots, a_n)) = f \bullet (F(a_1), \dots, F(a_n)) $, $ F $ gives a functor $ F: \R_A \to \R_B $ that preserves the terminal object, the object $ \mathbf 1_1 $, the products, their projections, the exponential objects and the natural isomorphisms $ \R_A(C, B^A) \cong \R_A(C \times A, B) $. This induces a $ \lambda $-theory morphism $ E(\mathbf 1_1) \to E(\mathbf 1_1) $ between the endomorphism theories of $ \mathbf 1_1 : A $ and $ \mathbf 1_1 : B $.

\begin{remark}
  Instead of in $ \R_A $ and $ \R_B $, Hyland tries to do the above in the `presheaf' categories $ \RAct{A_1} $ and $ \RAct{B_1} $. $ F $ induces a monoid morphism $ A_1 \to B_1 $, which gives a functor $ C_{A_1} \to C_{B_1} $. Precomposing with this, we get a functor $ \RAct{B_1} \to \RAct{A_1} $, and we only get the functor $ \RAct{A_1} \to \RAct{B_1} $ in the right direction after taking a Left Kan extension (the "tensor product": see Lemma \ref{lem:scalar-extension}).
\end{remark}

\begin{lemma}
  The functors on $ \R_A $ and $ \RAct{A_1} $ induced by $ F $ commute with the embedding of $ \R_A $ and $ \R_B $ into $ \RAct{A_1} $ and $ \RAct{B_1} $. In other words, the diagram below $ 2 $-commutes:
  \begin{center}
    \begin{tikzcd}
      \R_A \arrow[r, "F"] \arrow[d, "{\R_A(\mathbf 1_1, -)}"] & \R_B \arrow[d, "{\R_B(\mathbf 1_1, -)}"]\\
      \RAct{A_1} \arrow[r, "F_*"] & \RAct{B_1}
    \end{tikzcd}
  \end{center}
\end{lemma}
\begin{proof}
  Given $ X : \R_A $, we need to show that we have a natural isomorphism of sets with a right $ B_1 $-action $ \psi: \R_B(\mathbf 1_1, F(X)) \xrightarrow \sim F_*(\R_A(\mathbf 1_1, X)) $, that is, we need
  \[ \psi: \{ f : B \mid F(X) \circ f = f \} \xrightarrow \sim \{ f : A \mid X \circ f = f \} \times B_1 / \sim \]
  with the equivalence relation on the latter given by $ (f, F(a) \circ b) \sim (f \circ a, b) $ for all $ f : \R_A(\mathbf 1_1, X) $, $ b : B_1 $ and $ a : A_1 $. We can take $ \psi $ to be
  \[ \psi(f) = (X, f) \quad \text{and} \quad \psi^{-1}(f, b) = F(f) \circ b, \]
  which is $ B_1 $-equivariant and natural in $ X $.
  % We have
  % \[ \psi^{-1}(\psi(f)) = \psi^{-1}(X, f) = F(X) \circ f = f \]
  % \[ \psi(\psi^{-1}(f, b)) = \psi(F(f) \circ b) = (X, F(f) \circ b) = (X \circ f, b) = (f, b) \]
  % We need to show that this is natural in $ X $. Therefore, take $ g : \R_A(X, Y) $. Then $ \R_B(\mathbf 1_1, F(g)) $ is given by postcomposition with $ F(g) $. Also, $ F_*(\R_A(\mathbf 1_1, g)) $ is given by postcomposing with $ g $ on the component $ \R_A(\mathbf 1_1, g) $. Then
  % \[ \psi(F(g) \circ f) = (Y, F(g) \circ f) = (Y \circ g, f) = (g \circ X, f) \]
\end{proof}

For completeness' sake, the rest of this section will describe Hyland's reasoning a bit more:
\begin{lemma}
  The extension of scalars $ F_* $ sends $ U_A $ to $ U_A $ and preserves finite products.
\end{lemma}
\begin{proof}
  By Lemma \ref{lem:scalar-extension-monoid-monoid-action}, we have $ F_*(U_A) \cong U_A $.

  We will show that $ F_* $ preserves binary products and the terminal object.

  We use Lemma \ref{lem:scalar-extension-terminal} to show that $ F_* $ preserves the terminal object. We take (very similar to the terminal object in $ \R $):
  \[ a_0 = (\lambda x_1 x_2, x_2) \bullet () : A_1 \quad \text{and} \quad b_0 = (\lambda x_1 x_2, x_2) \bullet () : B_1 \]
  and $ a_0 $ is weakly terminal because for all $ a : B_1 $, we have $ F(a_0) \circ a = b_0 $.

  We use Lemma \ref{lem:scalar-extension-product} to show that $ F_* $ also preserves the product. Therefore, given $ a_1, a_2 : B_1 $. Take $ b = \langle x_1, x_2 \rangle \bullet (a_1, a_2) $, together with the familiar projections $ \pi_i \bullet () : A_1 $. We have $ a_i = F(\pi_i) \circ a $.

  Now, for some $ b^\prime: B_1 $ and $ \pi_1^\prime, \pi_2^\prime: A_1 $ such that $ a_i = F(\pi_i^\prime) \circ b^\prime $, take $ m = \langle \pi_1^\prime, \pi_2^\prime \rangle $. Then $ \pi_i \circ m = \pi_i^\prime $ and $ F(m) \circ a^\prime = a $, so $ (a, \pi_1, \pi_2) $ is weakly terminal and $ F_* $ preserves binary products.

  Since any finite product is (isomorphic to) a construction with a repeated binary product and the terminal object, the fact that $ F_* $ preserves binary products and the terminal object shows that $ F_* $ preserves all finite products.
\end{proof}

Now, we can start defining our lift of $ F $:
\begin{definition}
  We can send an element $ g: E(U_A)_n = \RAct{A}(U_A^n, U_A) $ to
  \[ F_*(g): \RAct{A^\prime}(f(U_A^n), f(U_A)) \cong \RAct{A^\prime}((U_{A^\prime})^n, U_{A^\prime}) = E(U_{A^\prime})_n \]
  so we have a morphism $ \bar F: \LamTh(E(U_A), E(U_{A^\prime})) $.
\end{definition}

\begin{remark}
  The fact that $ \bar F $ preserves the variables and substitution is not very hard, since these are just defined in terms of finite products of $ U_A $ and $ \bar F $ preserves finite products and $ U_A $.

  However, showing that it is a $ \lambda $-theory morphism is a different matter. Hyland claims
  \begin{quote}
    $ F $ preserves $ \mathbf 1_n $, which determines the function space as a retract of the universal. So $ \bar F $ preserves the retract and the result follows.
  \end{quote}
  Although this covers the core of the argument, it is very complicated to actually verify that this works, because we need to pass through a lot of isomorphisms, and check that they work nicely together:
  \begin{align*}
    \alpha_A: \RAct{A_1}(X \times Y, Z) &\xrightarrow{\sim} \RAct{A}(X, Z^Y);\\
    \beta: F_*(U_A) &\xrightarrow{\sim} U_{A^\prime};\\
    \bar \gamma: F_*(A \times B) &\xrightarrow{\sim} F_*(A) \times F_*(B);\\
    \gamma_n: F_*(X^n) &\xrightarrow{\sim} F_*(X)^n;\\
    % \delta: F_*(X^Y) &\xrightarrow{\sim} F_*(X)^{F_*(Y)};\\
    \delta_A: U_A^{U_A} &\xrightarrow{\sim} A_2.
  \end{align*}
  % with $ \gamma_{n + 1} = \bar{\gamma} \cdot (\gamma_n \times \id X) $.
  % Then, for $ s: E(U_A)_{n + 1} $, we have $ \lambda_A(s) = \alpha_A(s) \cdot \delta_A \cdot \pi_A : \RAct{A_1}(U_A^n, U_A) $ for the projection $ \pi_A: A_2 \to U_A $. However, note that $ f^*(\lambda_A(s)): \RAct{A^\prime_1}(f^*(U_{A^\prime}^n), f^*(U_{A^\prime})) $. To compare this to $ \lambda_{A^\prime}(\dots) $, we actually need to take
  % \[ (\beta^{-1})^n \cdot \gamma_n^{-1} \cdot f^*(\lambda_A(s)) \cdot \beta : \RAct{A^\prime_1}(U_A^n, U_A). \]
  % On the other hand, we also have $ f^*(s): \RAct{A^\prime_1}(f^*(U_A^{n + 1}), f^*(U_A)) $ and we cannot apply $ \lambda_{A^\prime} $ directly. Instead, the term that we end up with is
  % \[ \lambda_{A^\prime}((\beta^{-1})^{n + 1} \cdot \gamma_{n + 1}^{-1} \cdot f^*(s) \cdot \beta): \RAct{A^\prime_1}(U_A^n, U_A). \]
  % So the equality that we need to prove is (using functoriality of $ f^* $ and naturality of $ \alpha_{A^\prime} $):
  % \begin{align*}
  %   &(\beta^{-1})^n \cdot \gamma_n^{-1} \cdot f^*(\alpha_A(s)) \cdot f^*(\delta_A \cdot \pi_A) \cdot \beta\\
  %   &= (\beta^{-1})^n \cdot \gamma_n^{-1} \cdot \alpha_{A^\prime}((\id X^n \times \beta^{-1}) \cdot \bar{\gamma}^{-1} \cdot f^*(s)) \cdot \beta^{U_A} \cdot \delta_{A^\prime} \cdot \pi_{A^\prime}.
  % \end{align*}
  % Because of the complicated definition of each of these terms, I was unable to verify the correctness of this statement (and the similar statement about $ \rho: E(U_A)_n \to E(U_A)_{n + 1} $) within a day, even though I am willing to believe Hyland's claim.
  % \TODO

  % Given a morphism $ t: X \times Y \to Z $, $ \alpha_{A_1}(t): X \to (U_A \times Y \to Z) $ is given by
  % \[ \alpha(t)(x)(a, y) = t(x a, y) \]

  % Also, $ \beta: f^*(U_A) \xrightarrow{\sim} U_{A^\prime} $ is given, for $ a: A_1 $ and $ a^\prime : A^\prime_1 $, by
  % \[ \beta(a, a^\prime) = f(a) a^\prime \quad \text{and} \quad \beta^{-1}(a^\prime) = (1, a^\prime). \]

  % Given a morphism $ s: X \to Y $, we have $ f^*(s): f^*(X) \to f^*(Y) $ given by
  % \[ f^*(s)(x, a^\prime) = (s(x), a^\prime). \]

  % Finally, we have
  % \[ \delta(s) = \lambda x_1 x_2, s(p_1, p_2)(\lambda x_3, x_3 x_1 x_2) \]
  % with $ p_i = \lambda x_1, x_1 (\lambda x_2 x_3, x_{i + 1}) $.

  % For some $ s: U_A^{n + 1} \to U_A $, the left hand side sends $ (a, (a^\prime_1, \dots, a^\prime_n)): f^*(U_A^n) $ to
  % \begin{align*}
  %   &\lambda x_1 x_2, f(s((a_i p_1)_i, p_2)) (\lambda x_3, x_3 x_1 x_2) \circ a^\prime\\
  %   &= \lambda x_1 x_2, f(s((a_i p_1)_i, p_2)) (\lambda x_3, x_3 a^\prime (x_1) x_2)
  % \end{align*}
  % and the right hand side sends it to
  % \begin{align*}
  %   \lambda x_1 x_2, \lambda x_3, (f(s((a_i p_1)_i, p_2))((\lambda x_4, x_4 (a^\prime p_1 (\lambda x_3, x_3 x_1 x_2)) (p_2 (\lambda x_3, x_3 x_1 x_2)))(x_3)))
  % \end{align*}
\end{remark}

\subsection{Essentially surjective}

\begin{lemma}
  We have an isomorphism of $ \Lambda $-algebras $ \epsilon: E(\mathbf 1_1)_0 \xrightarrow \sim A $.
\end{lemma}
\begin{proof}
  Take $ c_n = (\lambda x_{n + 1}, x_{n + 1}): \Lambda_n $. Note that $ E(\mathbf 1_1)_0 $ is given by $ \{ a : A \mid (\lambda x_2, x_1 c_2) \bullet a = a \} $. Therefore, we have a bijection given by
  \[ \epsilon(a) = (x_1 c_1) \bullet a \quad \text{and} \quad \epsilon^{-1}(a) = (\lambda x_2, x_1) \bullet a. \]
  Now, to show that this is an isomorphism of $ \Lambda $-algebras, recall that $ \bullet: \R_A(U^n, U) \times \R_A(I, U)^n \to \R_A(U) $ is given by precomposition with the product morphism and that the $ \Lambda $-algebra structure on $ E(\mathbf 1_1)_0 $ is given by the embedding $ f \mapsto \iota_\Lambda(f) \bullet_A () $ of $ \Lambda $ into $ E(\mathbf 1_1)_0 $. We have for all $ f: \Lambda_n $, and all $ a : E(\mathbf 1_1)_0^n $,
  \begin{align*}
    \epsilon(f \bullet_{E(\mathbf 1_1)} a)
    &= ((\iota_\Lambda(f) \bullet_A ()) \circ \langle a_1, \dots, a_n \rangle)(c_n)\\
    &= (\iota_{0, n}(\iota_\Lambda(f)) ((\dots((c_n, x_1 c_n), x_2 c_n), \dots), x_n c_n)) \bullet_A a\\
    &= (\iota_{0, n}(\iota_\Lambda(f)) ((\dots((c_n, x_1), x_2), \dots), x_n)) \bullet_A (\epsilon(a_i))_i,
  \end{align*}
  writing $ \bar x_n $ for $ ((\dots((c_n, x_1), x_2), \dots), x_n) $, and leaving out the $ \iota_{0, n} $, all we need to do is show that for all $ f: \Lambda_n $,
  \[ \iota_\Lambda(f) \bar x_n = f. \]
  We will do this by structural induction on $ f $.
  \begin{itemize}
    \item If $ f = x_{n, i} $, we have $ \iota_\Lambda(f) = \pi_2 \circ \underbrace{\pi_1 \circ \dots \circ \pi_1}_{n - i} $, and
      \[ (\pi_2 \circ \pi_1 \circ \dots \circ \pi_1) \bar x_n = x_{n, i}. \]
    \item If $ f = \lambda x_{n + 1}, g $ for some $ g: \Lambda_{n + 1} $, we have
      \[ \iota_\Lambda(f) = (\lambda x_1 x_2, \iota_{0, 2}(\iota_\Lambda(g)) (x_1, x_2)), \]
      and if the induction hypothesis holds for $ g $, then
      \begin{align*}
        \iota_\Lambda(f) \bar x_n
        &= (\lambda x_{n + 1} x_{n + 2}, \iota_\Lambda(g) (x_{n + 1}, x_{n + 2})) \bar x_n\\
        &= \lambda x_{n + 1}, \iota_\Lambda(g) (\bar x_n, x_{n + 1})\\
        &= \lambda x_{n + 1}, g.
      \end{align*}
    \item Recall that application in a $ \lambda $-theory is given by $ g_1 g_2 = \rho(g_1) \bullet (x_1, \dots, x_n, g_2) $. Now, if $ f = g_1 g_2 $ for $ g_1, g_2 : \Lambda_{n + 1} $, we have
      \[
        \iota_\Lambda(f)
        = (\lambda x_1, \iota_\Lambda(g_1) (\pi_1 x_1) (\pi_2 x_1)) \circ \langle \id{U^n}, \iota_\Lambda(g_2) \rangle
        = \lambda x_1, \iota_\Lambda(g_1) x_1 (\iota_\Lambda(g_2) x_1),
      \]
      and if the induction hypothesis holds for $ g_1 $ and $ g_2 $, then
      \begin{align*}
        \iota_\Lambda(f) \bar x_n
        &= (\lambda x_{n + 1}, \iota_\Lambda(g_1) x_{n + 1} (\iota_\Lambda(g_2) x_{n + 1})) \bar x_n\\
        &= \iota_\Lambda(g_1) \bar x_n (\iota_\Lambda(g_2) \bar x_n)\\
        &= g_1 g_2.
      \end{align*}
  \end{itemize}
\end{proof}

Hyland shows the same fact in a slightly higher-level way.

For his proof, we already need the unit of the adjunction. The quest for this counit boils down to a version of Scott's representation theorem.
\begin{lemma}
  For a $ \lambda $-theory $ L $, we can define an (iso)morphism
  \[ \eta: \LamTh(L, E(U_{L_0})). \]
\end{lemma}
\begin{proof}
  Note that for $ \R $ the category of retracts of $ L $,
  \[ \mathbf R \xrightarrow \sim \mathbf R_{L_0} \xrightarrow{Y} P \R_{L_0} \xrightarrow \sim P C_{{L_0}_1} \xrightarrow \sim \RAct{{L_0}_1} \]
  is a fully faithful functor that preserves finite products and exponential objects, and that $ U_{L_0} $ is the image of $ U = (\lambda x_1, x_1) $ under this embedding, so we have an isomorphism $ E(U) \cong E(U_{L_0}) $. Then $ \eta $ arises by composing this with the isomorphism from Scott's representation theorem (Theorem \ref{thm:Scott})
  \[ \eta: L \xrightarrow \sim E(U) \xrightarrow \sim E(U_{L_0}). \]
  Note that on the terms without free variables, this becomes
  \[ \eta_0:
    L_0
      \xrightarrow{f \mapsto (\lambda x_1, \iota_{0, 1}(f))}
    \R(I, U)
      \xrightarrow{f \mapsto (I \mapsto f)}
    \RAct{(L_0)_1}(\{I\}, (L_0)_1),
  \]
  so $ \eta_0(f) = (I \mapsto (\lambda x_1, \iota_{0, 1}(f))) $.
\end{proof}

Alternatively, we can use Hyland's version of the representation theorem:
\begin{lemma}
  For a $ \lambda $-theory $ L $, we can define an (iso)morphism
  \[ \eta: \LamTh(L, E(U_{L_0})). \]
\end{lemma}
\begin{proof}
  Note that we have a chain of equivalences (Lemma \ref{lem:equivalent-presheaf-cats} and Remark \ref{rem:ract-presheaf-equivalence})
  \[ \Pshf L \xrightarrow \sim P \mathbf L \xrightarrow \sim P C_{L_1} \xrightarrow \sim \RAct{L_1} \xrightarrow \sim \RAct{{L_0}_1} \]
  and $ U_{L_0} $ is isomorphic to the image of the theory presheaf $ L $ under this equivalence. Then $ \eta $ arises by combining this with the isomorphism from Scott's representation theorem (Theorem \ref{thm:representation-theorem})
  \[ \eta: L \xrightarrow \sim E(L) \xrightarrow \sim E(U_{L_0}). \]
  Note that on the terms without free variables, this becomes
  \[ \eta_0:
    L_0
      \xrightarrow{f \mapsto (\star \mapsto \iota_{0, n}(f))_n}
    \Pshf L(I, L)
      \xrightarrow{F \mapsto (\star \mapsto (\lambda x_1, F_1(\star)))}
    \RAct{(L_0)_1}(\{\star\}, (L_0)_1),
  \]
  so $ \eta_0(f) = (\star \mapsto (\lambda x_1, \iota_{0, 1}(f))) $, which luckily coincides with the $ \eta_0 $ given above.
\end{proof}

\begin{lemma}
  We have a bijection $ \epsilon_A : E(U_A)_0 \cong A $, sending $ s $ to $ x_1 (\lambda x_2, x_2) \bullet (s(\star)) $.
\end{lemma}
\begin{proof}
  In Lemma \ref{lem:global-action-elements}, we showed that $ E(U_A)_0 $ corresponds to the set of $ A_1 $-equivariant elements of $ U_A $, sending $ s $ to $ s(\star) $. Now, for an $ A_1 $-equivariant element $ a $,
  \[ (\lambda x_2, x_1 (\lambda x_3, x_3)) \bullet a = a \circ ((\lambda x_1 x_2, x_2) \bullet ()) = a \]
  so we can send $ a $ to $ A $ as $ (x_1 (\lambda x_2, x_2)) \bullet a $ and it has (two-sided) inverse $ (\lambda x_2, x_1) \bullet a $.
\end{proof}

We want to show that $ \epsilon_A $ is an isomorphism of $ \Lambda $-algebras. We use Lemma \ref{lem:make-is-lambda-algebra-morphism} for this, so we need to show that it preserves the application and the $ \Lambda $-definable constants.

\begin{lemma}
  For $ \epsilon_A $ as above, we have for all $ a, b: E(U_A)_0 $, we have
  \[ \epsilon_A((x_1 x_2) \bullet (a, b)) = (x_1 x_2) \bullet (\epsilon_A(a), \epsilon_A(b)). \]
\end{lemma}
\begin{proof}
  For $ a, b: E(U_A)_0 $, we have, for the isomorphism $ \delta: \RAct{A_1}(U_A^{U_A}, A_2) $,
  \begin{align*}
    \epsilon_A((x_1 x_2) \bullet (a, b)) &= (x_1 (\lambda x_3, x_3) (x_2 (\lambda x_3, x_3))) \bullet (a(\star), b(\star))\\
    &= (x_1 x_2) \bullet (\epsilon_A(a), \epsilon_A(b))
  \end{align*}
  and this concludes the proof.
\end{proof}

\begin{lemma}\label{lem:counit-natural}
  Let $ F: A \to B $ be a $ \Lambda $-algebra morphism. Then the following diagram commutes:
  \begin{center}
    \begin{tikzcd}
      E(U_A)_0 \arrow[d, "\epsilon_A"] \arrow[r, "\bar F_0"] & E(U_B)_0 \arrow[d, "\epsilon_A"]\\
      A \arrow[r, "f"] & B
    \end{tikzcd}
  \end{center}
\end{lemma}
\begin{proof}
  The functor $ F_* : \RAct{A_1} \to \RAct{B_1} $ sends $ X : \RAct{A_1} $ to $ X \times B_1 / \sim : \RAct{B_1} $. We have isomorphisms
  \[ \beta: F_*(U_A) \xrightarrow \sim U_B \quad \text{and} \quad \gamma: F_*(I) \xrightarrow \sim I, \]
  with
  \[ \beta(a, b) = F(a) \circ b \quad \text{and} \quad \gamma^{-1}(\star) = (\star, (\lambda x_1 x_2, x_2) \bullet ()). \]
  Then $ \bar F: \RAct{A_1}(I, U_A) \to \RAct{B_1}(I, U_B) $ is given by
  \[
    \bar F(s)(\star)
    = \gamma^{-1} \cdot (s \times \id{B_1}) \cdot \beta
    = (\lambda x_2, x_1 (\lambda x_3, x_3)) \bullet F(s(\star)),
  \]
  so
  \[
    (\bar F \cdot \epsilon_B)(s)
    = (x_1 (\lambda x_2, x_2)) \bullet F(s(\star))
    = (\epsilon_A \cdot F)(s),
  \]
  which concludes the proof.
\end{proof}

\begin{lemma}
  For $ \epsilon_A $ as above, we have for all $ s: \Lambda_0 $,
  \[ \epsilon_A(s \bullet ()) = s \bullet (). \]
\end{lemma}
\begin{proof}
  Consider the following diagram, with $ F: \Alg \Lambda(\Lambda_0, A) $ given by $ s \mapsto s \bullet () $:
  \begin{center}
    \begin{tikzcd}
      E(U_{\Lambda_0})_0
        \arrow[r, "(\bar F)_0"]
        \arrow[d, "\epsilon_{\Lambda_0}"]
      & E(U_A)_0
        \arrow[d, "\epsilon_A"]\\
      \Lambda_0
        \arrow[r, "F"]
        \arrow[u, bend left, "\eta_0"]
      & A
    \end{tikzcd}
  \end{center}
  By Lemma \ref{lem:counit-natural}, the square commutes. Also, note that $ \eta_0 \cdot \epsilon_{\Lambda_0} $ sends $ s : \Lambda_0 $ to
  \[ (x_1 (\lambda x_2, x_2)) \bullet (\lambda x_1, \iota_{0, 1}(s)) = s. \]
  Recall that there exists a unique morphism $ \iota_\Lambda: \LamTh(\Lambda, E(U_A)) $, and that for all $ s: \Lambda_0 $, $ s \bullet () = \iota_\Lambda(s) \bullet () = \iota_\Lambda(s) $. Since we have $ \eta \cdot \bar F : \LamTh(\Lambda, E(U_A)) $, we must have $ \iota_\Lambda = \eta \cdot \bar F $ and
  \begin{align*}
    \epsilon_A(s \bullet_{E(U_A)} ())
    &= \epsilon_A(\bar{F_0}(\eta_0(s)))\\
    &= F(\epsilon_{\Lambda_0}(\eta_0(s)))\\
    &= F(s)\\
    &= s \bullet_A (),
  \end{align*}
  which concludes the proof.
\end{proof}

\subsection{Fully faithful}

\TODO

\subsection{Adjoint equivalence}

\begin{theorem}
  There exists an adjoint equivalence between the category of $ \lambda $-theories, and the category of algebras of $ \Lambda $.
\end{theorem}
\begin{proof}
  We will show that the functor $ L \mapsto L_0 $ is an equivalence of categories.

  It is essentially surjective, because $ L $ is isomorphic \TODO to $ E(U_A) $.

  Now, given morphisms $ f, f^\prime: L \to L^\prime $. Suppose that $ f_0 = f^\prime_0 $. Suppose that $ L $ and $ L^\prime $ have $ \beta $-equality. Then, given $ l: L_n $, we have
  \[ f_n(l) = \rho^n(\lambda^n(f_n(l))) = \rho^n(f_0(\lambda^n(l))) = \rho^n(f^\prime_0(\lambda^n(l))) = \rho^n(\lambda^n(f^\prime_n(l))) = f^\prime_n(l), \]
  so the functor is faithful.

  The functor is full because a $ \Lambda $-algebra morphism $ f: A \to A^\prime $ induces a functor $ f^*: \RAct{A^\prime} \to \RAct{A} $, and via left Kan extension we get a left adjoint $ f^*: \RAct{A} \to \RAct{A^\prime} $ with $ f^*(A_1) \cong A^\prime_1 $. Now, $ f^* $ preserves (finite) products, so we have maps $ \RAct{A}(A_1^n, A_1) \to \RAct{A^\prime}((A^\prime_1)^n, A^\prime_1) $ and so a map $ E(U_A) \to E(U_{A^\prime}) $. This map, when restricted to a map $ \RAct{A}(1, A_1) \to \RAct{A^\prime}(1, A_1) $, and transported along the isomorphism $ a \mapsto a I $ \TODO, is equal to $ f $ \TODO.
\end{proof}


\section{An alternative proof for the fundamental theorem}


\section{Theory of extensions}

\begin{lemma}
  The category of $ T $-algebras has coproducts.
\end{lemma}
\begin{proof}
  \TODO
\end{proof}

\begin{definition}[Theory of extensions]
  Let $ T $ be an algebraic theory and $ A $ a $ T $-algebra. We can define an algebraic theory $ T_A $ called `the theory of extensions of $ A $' with $ (T_A)_n = T_n + A $. The left injection of the variables $ x_i : T_n $ gives the variables.
  Now, take $ h: (T_n + A)^m $. Sending $ g: T_m $ to $ \varphi(g) := g \bullet h $ gives a $ T $-algebra morphism $ T_m \to T_n + A $ since
  \[ \varphi(f \bullet g) = f \bullet g \bullet h = f \bullet (g_i \bullet h) = f \bullet (\varphi(g_i))_i. \]
  This, together with the injection morphism of $ A $ into $ T_n + A $, gives us a $ T $-algebra morphism from the coproduct: $ T_m + A \to T_n + A $. We especially have a function on sets $ (T_m + A) \times (T_n + A)^m \to T_n + A $, which we will define our substitution to be.
\end{definition}

\begin{lemma}
  $ T_A $ is indeed an algebraic theory.
\end{lemma}
\begin{proof}
  \TODO
\end{proof}
