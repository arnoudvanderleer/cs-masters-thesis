\chapter{Category Theoretic Preliminaries}

I will assume a familiarity with the category-theoretical concepts presented in \autocite{CT4P}. These include categories, functors, isomorphisms, natural transformations, adjunctions, equivalences and limits.

\section{Notation}
For an object $ c $ in a category $ C $, I will write $ c: C $.

For a morphism $ f $ between objects $ c $ and $ c^\prime $ in a category $ C $, I will write $ f: C(c, c^\prime) $ or $ f: c \to c^\prime $.

For composition of morphisms $ f: C(c, d) $ and $ g: C(d, e) $, I will write $ f \cdot g $.

For composition of functors $ F: A \to B $ and $ G: B \to C $, I will write $ F \bullet G $.

\section{Universal Arrows}

One concept in category theory that can be used to describe a lot of limits and adjunctions is that of a universal arrow (see for example \autocite{MacLane}, Part III)
\begin{definition}
  A \iindex{universal arrow} from an object $ c: C $ to a functor $ F: D \to C $ consists of an object $ d: D $ and a morphism $ f: D(c, F(d)) $ such that for every similar pair $ (d^\prime, f^\prime) $, $ f^\prime $ factors uniquely as $ f \cdot F(g) $ for some $ g: C(d, d^\prime) $:
  \begin{center}
    \begin{tikzcd}
      c \arrow[d, "f"'] \arrow[rd, "f^\prime"] &\\
      F(d) \arrow[r, "F(g)"', dashed] & F(d^\prime)
    \end{tikzcd}
  \end{center}
\end{definition}

Alternatively, we can characterize universal arrows by their action on hom-sets:
\begin{lemma}
  Let $ F: C \to D $ be a functor and $ d: D $ an object. An object $ c: C $ and an arrow $ f: D(d, F(c)) $ form a universal arrow from $ d $ to $ F $ if and only if the function
  \[ (g \mapsto f \cdot F(g)) : C(c, x) \cong D(d, F(x)) \]
  is a bijection.

  Conversely, for all $ c: C $ and $ d: D $, every bijection
  \[ C(c, x) \cong D(d, F(x)) \]
  that is natural in $ x $ arises in this way from some universal arrow $ f: D(d, F(c)) $.
\end{lemma}
\begin{proof}
  See \autocite{MacLane}, Chapter III.2, Proposition 1.
\end{proof}

There is also the dual concept of a universal arrow $ (d, f) $ from a functor $ F $ to an object $ c: C $. Its universal property can be summarized in the following diagram:
\begin{center}
  \begin{tikzcd}
    F(d^\prime)\arrow[rd, "f^\prime"']  \arrow[r, "F(g)", dashed] & F(d) \arrow[d, "f"]\\
    & c
  \end{tikzcd}
\end{center}

\section{Adjunctions and equivalences}

Recall that an \iindex{adjunction} $ L \dashv R $ is a pair of functors
\begin{center}
  \begin{tikzcd}
    D \arrow[r, bend right, "R"'{name=R}] & C \arrow[l, bend right, "L"'{name=L}]
  \end{tikzcd}
\end{center}
with natural transformations (the unit and counit)
\[ \eta: \id C \Rightarrow L \bullet R \quad \text{and} \quad \epsilon: R \bullet L \Rightarrow \id D \]
such that the diagrams
\begin{center}
  \begin{tikzcd}
    L \arrow[rd, "\eta \bullet L"'] \arrow[rr, "\id L"] & & L\\
    & L \bullet R \bullet L \arrow[ur, "L \bullet \epsilon"']
  \end{tikzcd}
  \qquad
  \begin{tikzcd}
    R \arrow[rd, "R \bullet \eta"'] \arrow[rr, "\id R"] & & R\\
    & R \bullet L \bullet R \arrow[ur, "\epsilon \bullet R"']
  \end{tikzcd}
\end{center}
commute (these are called the \iindex{triangle identities} or \iindex{zigzag identities}). Here the natural transformation $ \eta \bullet L: L \bullet R \bullet L $ is the natural transformation $ \eta $ whiskered on the right by $ L $, and the other whiskered transformations are similar.

An alternative characterization (see \autocite{MacLane}, chapter IV.1, Theorem 2) of an adjunction $ L \dashv R $ is as a natural bijection
\[ \varphi: D(L(c), d) \xrightarrow{\sim} C(c, R(d)). \]
Naturality means that for all $ f: C(c^\prime, c) $, $ g: D(d, d^\prime) $ and $ h: D(L(c), d) $,
\[ \varphi(L(f) \cdot h \cdot g) = f \cdot \varphi(h) \cdot R(g). \]

Lastly, one can construct an adjunction using universal arrows. This lends itself particularly well for a formalization, where it is often preferable to have as little `demonstranda' as possible:
\begin{lemma}
  One can construct an adjunction $ (L, R, \eta, \epsilon) $ as above from only the functor $ L: C \to D $ and, for each $ c: C $, a universal arrow $ (R(c), \epsilon_c) $ from $ L $ to $ c $.
\end{lemma}
\begin{proof}
  See \autocite{MacLane}, Chapter IV.1, Theorem 2 (iv).
\end{proof}

\subsection{Adjoint equivalences}
An (adjoint) equivalence of categories has multiple definitions. The one we will use here is the following:

\begin{definition}\label{def:equivalence-of-categories}
  An \iindex{adjoint equivalence} between categories $ C $ and $ D $ is a pair of adjoint functors $ L \dashv R $ like above such that the unit $ \eta: \id{C} \Rightarrow L \bullet R $ and counit $ \epsilon: R \bullet L \Rightarrow \id{D} $ are isomorphisms of functors.
\end{definition}

\subsection{Weak equivalences}
There is also the notion of `weak equivalence'. In some cases, this is equivalent to an adjoint equivalence (for example, when its domain is univalent).
\begin{definition}
  A functor $ F: C \to D $ is called a \iindex{weak equivalence} if it is essentially surjective and fully faithful.
\end{definition}

\subsection{Exponential objects}
Note that in the category of sets, for all $ X, Y: \SET $, we have a set $ (X \to Y) $. Also, for all $ X, Y, Z $, there is a (natural) bijection
\[ (X \times Y \to Z) \cong (X \to (Y \to Z)) \]
which we can also write as
\[ \SET(X \times Y, Z) \cong \SET(X, (Y \to Z)). \]
In other words, we have functors $ X \mapsto X \times Y $ and $ Z \mapsto (Y \to Z) $, and these two form an adjunction. The following generalizes this
\begin{definition}
  A category $ C $ has \textit{exponential objects}\index{exponential objects} (or \textit{exponentials}) if for all $ c: C $, the functor $ c^\prime \mapsto c^\prime \times c $ has a right adjoint, which we denote $ d \mapsto d^c $.
\end{definition}

\begin{remark}
  It is actually very well possible that a category does not have all exponentials, but it has some objects $ c, d, d^c: C $ with a natural bijection
  \[ C(d^\prime \times c, d) \cong C(d^\prime, d^c). \]
  Then $ d^c $ is still called an exponential object.
\end{remark}

\subsection{Forgetful functors and free objects}

In mathematics, we often deal with objects that are `based on' other objects. For example, a ring is a set with some additional structure. Often, this is a relation between the respective categories (for example, in the case of a displayed category, see Section \ref{sec:displayed-categories}), and such a relation gives rise to a \iindex{forgetful functor}, that `forgets' about the additional structure. In the examples of rings and sets, the forgetful functor sends a ring to its underlying set, and a ring morphism to the function between the sets. However, note that there is no formal definition of forgetful functors. The name is more of a way to talk about the perceived relation between the categories.

\begin{definition}
  Given a forgetful functor $ F: C \to D $, we define the \textit{free functor}\index{free!functor} associated to $ F $ to be the left adjoint to $ F $, if it exists.
\end{definition}

\begin{example}
  Consider the forgetful functor from the category of commutative rings to the category of sets, sending a ring to its underlying set. This has a left adjoint, sending the set $ \{ 1, 2, \dots, n \} $ to the polynomial ring $ \mathbb Z[X_1, \dots, X_n] $, and more generally, sending $ S $ to the polynomial ring $ \mathbb Z[X_s]_{s : S} $. This ring is then called `the free commutative ring on $ S $'. If $ S $ is finite of size $ n $, the ring is also called `the free commutative ring on $ n $ generators'.

  The free functor sends a function $ f: S \to T $ to the ring morphism $ \mathbb Z[X_s]_{s: S} \to \mathbb Z[X_t]_{t: T} $ that sends $ X_s $ to $ X_{f(s)} $.

  The natural bijection
  \[ \mathbf{Rng}(\mathbb Z[X_s]_{s : S}, R) \cong \SET(S, R) \]
  then sends $ f: \mathbf{Rng}(\mathbb Z[X_s]_{s : S}, R) $ to $ s \mapsto f(X_s) $ and $ g: \SET(S, R) $ to the morphism that sends $ X_s $ to $ g(s) $.
\end{example}

However, sometimes, we have a forgetful functor $ F: C \to D $, but we cannot give a free functor on the entire category $ D $. In such a case, we might still talk about free `objects':
\begin{definition}
  Let $ F: C \to D $ be a forgetful functor. Given $ d: D $, the \textit{free object}\index{free!object} on $ d $ is a universal arrow $ (c, f) $ from $ d $ to $ F $.
\end{definition}

\begin{remark}
  By \autocite{MacLane}, Chapter IV.1, Theorem 2 (ii), if we have a free object on every $ d: D $, we can piece these together to get a free functor associated to $ F $.
\end{remark}

\section{Yoneda}
We can embed a category $ C $ fully faithfully into the functor category $ P C = [\op C, \SET] $ as follows (see \autocite{Kashiwara}, Section 1.4):
\begin{definition}\label{def:Yoneda-embedding}
  The \iindex{Yoneda embedding} $ Y : C \hookrightarrow P C $ is given on objects by $ Y(c) = C(-, c) $:
  \[ Y(c)(d) = C(d, c) \quad \text{and} \quad Y(c)(f)(g) = f \cdot g \]
  for $ d: C $, $ f: C(d, d^\prime) $ and $ g: C(d^\prime, c) $. It sends a morphism $ f: C(c, c^\prime) $ to the natural transformation $ Y(f): C(-, c) \Rightarrow C(-, c^\prime) $ given by
  \[ Y(f)(d)(g) = g \cdot f \]
  for $ d: C $ and $ g: C(d, c) $.
\end{definition}

Now, this embedding has a couple of properties:
\begin{lemma}
  For any $ A: C $ and $ F : P C $, we have an equivalence $ P C(Y(A), F) \simeq F(A) $, and this equivalence is natural in $ c $ and $ F $.
\end{lemma}
\begin{proof}
  It sends a natural transformation $ \alpha: P C(Y(A), F) $ to the element $ \alpha_A(\id A) $. Conversely, it sends an element $ x : P(A) $ to the natural transformation $ \alpha $ given by $ \alpha_B(f) = P(f)(x) $ for all $ f: Y(A)(B) = C(B, A) $. For more details, see \autocite{Kashiwara}, Proposition 1.4.3.
\end{proof}

\begin{remark}
  For any category $ D $, the category $ [C, D] $ has (co)limits of some kind (terminal or initial object, (co)products, (co)equalizers) iff $ D $ does. These (co)limits are computed pointwise: for example, for binary products, $ (F \times G)(X) = F(X) \times G(X) $. In particular $ P C $ has all limits and colimits because $ \SET $ has all limits and colimits.
\end{remark}

\begin{remark}
  Also, for any small category $ C $ (small means that the collection of objects is a type in our type universe. For example: $ \TYPE $ or $ \SET $ are not small categories, because a type cannot contain itself), the presheaf category $ P C $ has exponential objects, given by
  \[ (F^G)(X) = \hom{PC}(Y(X) \times G, F) \]
  the natural transformations from the product functor of the Yoneda embedding of $ X $ and $ G $, to $ F $ (see \autocite{MacLane-Moerdijk}, Section I.6, Proposition 1).
\end{remark}

\begin{definition}
  Suppose that we have a functor $ F: C \to D $, and $ C $ and $ D $ both have binary products. Then for $ A, B : C $, we have morphisms $ \pi_1: A \times B \to A $ and $ \pi_2 : A \times B \to B $ and applying $ F $ to these yields morphisms from $ F(A \times B) $ to $ F(A) $ and $ F(B) $. We then have a product morphism
  \[ \langle F(\pi_1), F(\pi_2) \rangle: F(A \times B) \to F(A) \times F(B). \]
  Now, if this morphism is an isomorphism for all $ A, B : C $, we say that $ F $ \index{preservation of binary products}\textit{preserves binary products}.

  One can imagine that there exists a similar definition of preservation of limits in general, in which the limit morphism of $ F $ applied to the projections from the limit is an isomorphism for any limit in $ C $.
\end{definition}

\begin{definition}\label{def:exponentials-preservation}
  Suppose that we have a functor $ F: C \to D $ that preserves binary products, and $ C $ and $ D $ have exponential objects. Then for $ A, B : C $, we have natural bijections
  \[ \varphi: C(A^B \times B, A) \xrightarrow \sim C(A^B, A^B) \quad \text{and} \quad \psi: D(F(A^B) \times F(B), F(A)) \xrightarrow \sim D(F(A^B), F(A)^{F(B)}) \]
  This gives a morphism $ F(\varphi^{-1}(\id{A^B})) : D(F(A^B \times B), F(A)) $. Precomposing with the inverse of the isomorphism $ f: F(A^B \times B) \xrightarrow \sim F(A^B) \times F(B) $ and applying $ \psi $ gives
  \[ \psi(f^{-1} \cdot \varphi^{-1}(\id{A^B})) : D(F(A^B), F(A)^{F(B)}). \]
  We say that $ F $ \index{preservation of exponentials}\textit{preserves exponentials} if this morphism is an isomorphism for all $ A, B : C $. A name for a functor that preserves exponentials is a\iindex{cartesian functor}.
\end{definition}

\begin{lemma}
  The Yoneda embedding preserves limits.
\end{lemma}
\begin{proof}
  See \autocite{borceux}, Volume 1, Proposition 2.15.5 for the full proof, but note that for binary products, we have bijections
  \[ Y(A \times B)(X) \xrightarrow \sim Y(A)(X) \times Y(B)(X) \]
  sending $ f : C(X, A \times B) $ to the pair $ (f \cdot \pi_1, f \cdot \pi_2) $ and conversely, sending a pair $ (g_1, g_2) : C(X, A) \times Y(X, B) $ to the product morphism $ \langle g_1, g_2 \rangle : Y(X, A \times B) $. This idea is the core of the proof about all limits.
\end{proof}

\begin{lemma}
  The Yoneda embedding preserves exponentials.
\end{lemma}
\begin{proof}
  First of all, note that for $ A, B, X : C $, we have a sequence of isomorphisms  (\autocite{stackexchange:yoneda-exponentials})
  \begin{align*}
    Y(A^B)(X) &\cong P C(Y(X), Y(A^B))\\
    &\cong C(X, A^B)\\
    &\cong C(X \times B, A)\\
    &\cong P C(Y(X \times B), Y(A))\\
    &\cong P C(Y(X) \times Y(B), Y(A))\\
    &\cong P C(Y(X), Y(A)^Y(B))\\
    &\cong (Y(A)^Y(B))(X)
  \end{align*}
  using (once or twice) the Yoneda lemma, fully faithfulness of the Yoneda embedding, the property of the exponential object, and the fact that the Yoneda embedding preserves binary products.

  Some calculating shows that when applying this isomorphism to some $ f: Y(A^B)(X) $, we get the natural transformation $ h: P C(Y(X) \times Y(B), Y(A)) $ given by
  \[ h_Z(g_1, g_2) = \langle g_1, g_2 \rangle \cdot \varphi^{-1}(f) \]
  for all $ Z: C $ and $ (g_1, g_2) : Y(X)(Z) \times Y(B)(Z) $ and with the natural bijection
  \[ \varphi: C(X \times B, A) \xrightarrow \sim C(X, A^B). \]

  It turns out that when we apply the morphism in Definition \ref{def:exponentials-preservation} to $ f $, we get exactly the same natural transformation. Therefore, the morphism in Definition \ref{def:exponentials-preservation} is the isomorphism defined here and we conclude that $ Y $ preserves exponentials.
\end{proof}

For a functor between categories $ f: C \to D $, given the Yoneda embeddings $ Y_C : C \to P C $ and $ Y_D : D \to P D $ (we will often omit the subscript $ C $ and $ D $), we can create a diagram
\begin{center}
  \begin{tikzcd}
    C \arrow[r, "f"] \arrow[d, hookrightarrow, "Y"] & D \arrow[d, hookrightarrow, "Y"]\\
    P C & P D \arrow[l, "\op f_*"]
  \end{tikzcd}
\end{center}
Note that the arrows in this diagram are functors, so objects in a category, instead of elements of a set. Therefore, it does not make sense to talk about `equality' of the morphisms along the different paths, but we rather talk about isomorphism in the functor category $ [C, P C] $. If we have such an isomorphism, we say the diagram `2-commutes':
\begin{lemma}\label{lem:Yoneda-restriction-commutes}
  If $ f: C \to D $ is a fully faithful functor, the diagram above 2-commutes.
\end{lemma}
\begin{proof}
  For $ c, d : C $, since $ f $ is fully faithful, we have isomorphisms of sets, given by
  \[ Y(c)(d) = C(d, c) \xrightarrow[f_{d, c}]{\sim} D(f(d), f(c)) = \op f_*(Y(f(c)))(d). \]
  Also, for $ g: C(d^\prime, d) $, the following diagram commutes
  \begin{center}
    \begin{tikzcd}
      Y(c)(d) \arrow[d, "g \cdot -"] \arrow[r, "f_{d, c}"] & \op f_*(Y(f(c)))(d) \arrow[d, "f_{d^\prime, d}(g) \cdot -"]\\
      Y(c)(d^\prime) \arrow[r, "f_{d^\prime, c}"] & \op f_*(Y(f(c)))(d^\prime)
    \end{tikzcd}
  \end{center}
  so the isomorphism is natural in $ d $ and we have $ Y(c) \cong \op f_*(Y(f(c))) $ in $ P C $. Lastly, for $ g: C(c, c^\prime) $ and $ d: C $, the following diagram commutes
  \begin{center}
    \begin{tikzcd}
      Y(c)(d) \arrow[d, "- \cdot g"] \arrow[r, "f_{d, c}"] & \op f_*(Y(f(c)))(d) \arrow[d, "- \cdot f_{c, c^\prime}(g)"]\\
      Y(c^\prime)(d) \arrow[r, "f_{d, c^\prime}"] & \op f_*(Y(f(c^\prime)))(d)
    \end{tikzcd}
  \end{center}
  so the isomorphism is natural in $ c $ and we have $ Y \cong f \bullet Y \bullet \op f_* $ in $ [C, P C] $.
\end{proof}

\section{Fibrations}
Let $ P : E \to B $ be a functor. In this case, we will view this as the category $ E $ `lying over' the category $ B $, with for every point $ b: B $, a slice $ E_b = P^{-1}(B) $ lying `above' $ b $.

\begin{definition}
  A morphism $ f: E(y, z) $ is called \iindex{cartesian} if for all $ g: E(x, z) $ and $ h: B(P(x), P(y)) $ with $ h \cdot P(f) = P(g) $, there exists $ \bar h: E(x, y) $ such that $ P(\bar h) = h $ and $ \bar h \cdot f = g $, like illustrated in the following diagram from \autocite{nlab:grothendieck_fibration}
  \begin{center}
    \begin{tikzcd}[sep=large]
      E \arrow[d, "P"] &x \arrow[rr, "\forall g", bend left] \arrow[r, "\exists! \bar h"', dashed] & y \arrow[r, "f"'] & z\\
      B & P(x) \arrow[r, "\forall h"'] \arrow[rr, "P(g)", bend left] & P(y) \arrow[r, "P(f)"'] & P(z)
    \end{tikzcd}
  \end{center}
\end{definition}

\begin{definition}
  $ P $ is a \iindex{fibration} if for all $ y: E $ and morphisms $ f: B(x, P(y)) $, there exist an object $ \bar x: E $ and a cartesian morphism $ \bar f: E(\bar x, y) $ such that $ P(\bar x) = x $ and $ P(\bar f) = f $:
  \begin{center}
    \begin{tikzcd}
      E \arrow[d, "P"] & \bar x \arrow[r, "\exists \bar f", dashed] & y\\
      B & x \arrow[r, "\forall f"] & P(y)
    \end{tikzcd}
  \end{center}
\end{definition}

\section{(Co)slice categories}
Given an object in a category $ c: C $, the morphisms to and from $ c $ constitute the slice and coslice categories
\begin{definition}
  The \iindex{slice category} $ C \downarrow c $ is the category with as objects the morphisms to $ c $:
  \[ (C \downarrow c)_0 = \sum_{c^\prime: C} C(c^\prime, c). \]
  The morphisms from $ (c^\prime, f) $ to $ (c^{\prime\prime}, f^\prime) $ are the morphisms $ g: c^\prime \to c^{\prime\prime} $ making the following diagram commute.
  \begin{center}
    \begin{tikzcd}
      c^\prime \arrow[rr, "g"] \arrow[rd, "f"'] & & c^{\prime\prime} \arrow[ld, "f^\prime"]\\
      & c
    \end{tikzcd}
  \end{center}
\end{definition}
The \textit{coslice category}\index{slice category!co-} $ c \downarrow C $ is similar, but with the morphisms \textit{from} $ c $ instead of \textit{to} $ c $:
\[ (c \downarrow C)_0 = \sum_{c^\prime: C} C(c, c^\prime). \]

Now, if we have an object in a slice category, we can again look at the slice of the slice category over that object. However, this gives us nothing new:
\begin{lemma}
  Let $ (d, f) $ be an object in the slice category $ (C \downarrow c) $. The slice category $ ((C \downarrow c) \downarrow (d, f)) $ is equivalent to $ (C \downarrow d) $.
\end{lemma}
\begin{proof}
  An object of $ ((e, g), \alpha) : ((C \downarrow c) \downarrow (d, f)) $ is an object $ (e, g) : (C \downarrow c) $, together with a morphism $ \alpha: (C \downarrow c)((e, g), (d, f)) $. That is, a morphism $ \alpha: C(e, d) $ such that the obvious triangle commutes (shown in the diagram below on the far left).

  Then a morphism between $ ((e, g), \alpha) $ and $ ((e^\prime, g^\prime), \alpha^\prime) $ is a morphism $ \beta $ between $ (e, g) $ and $ (e^\prime, g^\prime) $ that commutes with $ \alpha $ and $ \alpha^\prime $. Note that a morphism between $ (e, g) $ and $ (e^\prime, g^\prime) $ is a morphism between $ e $ and $ e^\prime $ that commutes with $ g $ and $ g^\prime $.
  \begin{center}
    \begin{tikzcd}
      e \arrow[rdd, "g"'] \arrow[rd, "\alpha"] \arrow[rr, "\beta"] && e^\prime \arrow[ldd, "g^\prime"] \arrow[ld, "\alpha^\prime"']\\
      & d \arrow[d, "f" description]\\
      & c
    \end{tikzcd}
    $ \Leftrightarrow $
    \begin{tikzcd}
      e \arrow[rd, "\alpha"] \arrow[rr, "\beta"] && e^\prime \arrow[ld, "\alpha^\prime"']\\
      & d
    \end{tikzcd}
  \end{center}

  Now, note that $ g $ and $ g^\prime $ are completely determined by $ g = \alpha \cdot f $ and $ g^\prime = \alpha^\prime \cdot f $, so we can leave them out. Also, if $ \beta $ commutes with $ \alpha $ and $ \alpha^\prime $, it automatically also commutes with $ g $ and $ g^\prime $. Therefore, as shown above, we have a correspondence between objects and morphisms
  \[ \beta: ((e, g), \alpha) \to ((e^\prime, g^\prime), \alpha^\prime) \Leftrightarrow \beta: (e, \alpha) \to (e^\prime, \alpha^\prime). \]
\end{proof}

Also, it turns out that we can derive some structure of the slice categories from the original category:
\begin{lemma}
  For $ (d, f), (d^\prime, f^\prime) : (C \downarrow c) $, their product in the slice category is given by their pullback / fibered product $ d \times_c d^\prime $, together with the induced morphism $ g: d \times_c d^\prime \dasharrow c $.
\end{lemma}
\begin{proof}
  Consider the diagram below. The fibered product gives `projections' $ h $ and $ h^\prime $. Also, if we have some $ (e, \alpha) : (C \downarrow c) $, together with morphisms $ \beta : (e, \alpha) \to (d, f) $ and $ \beta^\prime : (e, \alpha) \to (d^\prime, f^\prime) $. Then $ \beta $ and $ \beta^\prime $ commute with $ f $ and $ f^\prime $, so by the universal property of the fibred product, there exists a unique morphism $ \gamma : e \to d \times_c d^\prime $ that makes the triangles with $ \beta $ and $ h $, and with $ \beta^\prime $ and $ h^\prime $ commute. Then $ \gamma $ commutes with $ \alpha $ and $ g $ as well, so it is a morphism in $ (C \downarrow c) $. This shows that $ (d \times_c d^\prime, g) $ has the universal property of the product in $ (C \downarrow c) $.
  \begin{center}
    \begin{tikzcd}
      e \arrow[rd, "\beta"] \arrow[rr, "\beta^\prime", bend left] \arrow[rrd, "\alpha"', bend right=49, shift right] \arrow[r, dashed, "\gamma"] & d \times_c d^\prime \arrow[r, "h^\prime"'] \arrow[d, "h"] \arrow[rd, dashed, "g"] & d^\prime \arrow[d, "f^\prime"] \\
      & d \arrow[r, "f"] & c
    \end{tikzcd}
  \end{center}
\end{proof}

For a category $ C $ with products, Hyland introduces the notation $ \Delta_X Y $ for the element $ (X \times Y, p_1) : (C \downarrow X) $, and we will follow his example in this.

In fact, $ \Delta_X : C \to C / X $ is a functor, with $ \Delta_X(f) = \id X \times f $ for $ f: C(Y, Y^\prime) $. This functor preserves the terminal object, products and pullbacks:
\begin{lemma}\label{lem:delta-limits}
  $ \Delta_X $ preserves all limits.
\end{lemma}
\begin{proof}
  Take a diagram $ ((A_i)_i, (f_j)_j) $ in $ C $. Suppose that this has a limit $ (L, (g_i)_i) : C $. Now, consider an object $ (B, q) : (C \downarrow X) $, together with morphisms $ h_i : (C \downarrow X)((B, q), \Delta_X A_i) $, that commute with the $ \Delta_X f_j $:
  \begin{center}
    \begin{tikzcd}
      & B \arrow[ldd, "h_{m_j}"'] \arrow[rdd, "h_{n_j}"]\\
      & X \times L \arrow[ld, "\Delta_X g_{m_j}"] \arrow[rd, "\Delta_X g_{n_j}"']\\
      X \times A_{m_j} \arrow[rr, "\Delta_X f_j"'] & & X \times A_{n_j}
    \end{tikzcd}
  \end{center}
  Then the morphisms in $ (C \downarrow X)((B, q), \Delta_X L) $, commuting with the $ \Delta_X g_j $ and $ h_j $ are the morphisms in $ C(B, X \times L) \cong C(B, X) \times C(B, L) $ that commute with the projections to $ X $ and the $ \id X \times g_j $ and $ h_j $. Since the morphisms in $ C(B, X) $ commuting with $ q $ and $ \id X $ are exactly $ q $, we can forget about this component, and the morphisms we are looking for correspond to the morphisms in $ C(B, L) $ that commute with the $ g_j $ and $ h_j \cdot p_1 $. Since $ (L, (g_j)_j) $ is a limit, this is a unique morphism.
\end{proof}

\begin{lemma}\label{lem:delta-exponentials}
  $ \Delta_X $ preserves exponential objects:
\end{lemma}
\begin{proof}
  See \autocite{borceux}, Volume 3, Lemma 5.8.2. This lemma shows this via the following equivalences:
  \begin{align*}
    (C \downarrow X)((A, f), \Delta_X Y^Z) &\cong C(A, Y^Z)\\
    &\cong C(A \times Z, Y)\\
    &\cong (C \downarrow X)((A \times X \times Z, \langle f, p_1 \rangle), \Delta_X Y)\\
    &\cong (C \downarrow X)((A, f) \times \Delta_X Z, \Delta_X Y)\\
  \end{align*}
\end{proof}

\section{Dependent products and sums}\label{sec:dependent-products}
The following is based loosely on Section 4.1 of \autocite{taylor}.

Take a category $ C $. To talk about dependent sums $ \sum_{a: A} X_a $ and products $ \prod_{a: A} X_a $ in $ C $, we first need some way to construct the family of objects $ (X_a)_a $. Of course, we can do this \textit{externally} using a set $ A $, and picking an object $ X_a : C $ for every element $ a : A $. We then have a category of such families $ C^A $, with objects $ (X_a)_a $ and morphisms $ (f_a)_a: C^A((X_a)_a, (Y_a)_a) $, with $ f_a: X_a \to Y_a $. We write $ C^A $ because we can view this as just the $ A $-fold power of $ C $. Now, this assignment of categories $ A \mapsto C^A $ can be turned into a contravariant (pseudo)functor of $ 2 $-categories $ \op \SET \to \Cat $. It sends a morphism $ f: A \to B $ to the `relabeling' or `substitution' functor $ C^B \to C^A $, $ (X_b)_b \mapsto (X_{f(a)})_a $.

However, there is also an \textit{internal} representation, as a morphism $ X \to A $. We can turn the collection of these morphisms over all the $ A : C $ simultaneously into a category $ C^2 $ (abusing notation a bit, writing $ 2 $ for the two-point category $ \bullet \to \bullet $). Then taking codomains $ (X \to A) \mapsto A $ gives a functor $ C^2 \to C $. The fiber of this functor above $ A $ is the slice category $ (C \downarrow A) $.

In $ \SET $, the external and internal ways of indexing are actually equivalent, because given a family $ (X_a)_a $ we can construct a morphism $ f: \sum_{a : A} X_a \to A $ and conversely, we can recover the family $ (X_a)_a $ as $ (f^{-1}(a))_a $.

Also note that for $ \SET $, if we consider an indexed family $ (X_a)_a $ as some function $ X: A \to \SET $, then substitution over $ \alpha: B \to A $ is just given by postcomposition $ X \circ \alpha: B \to \SET $. It turns out that in the internal representation this arises as the pullback
\begin{center}
  \begin{tikzcd}
    \sum_{b : B} X_{\alpha(b)} \arrow[r] \arrow[d, "\alpha^* f"] \arrow[dr, phantom, "\lrcorner", very near start] & \sum_{a : A} X_a \arrow[d, "f"]\\
    B \arrow[r, "\alpha"] & A
  \end{tikzcd}
\end{center}
This can be turned into a pullback or `substitution' functor $ \alpha^* $, which Taylor calls $ \mathtt{P}\alpha $. This turns the functor $ \SET^2 \to \SET $ into a fibration. We can construct $ \alpha^* : (C \downarrow A) \to (C \downarrow B) $ for any category $ C $ with pullbacks and any morphism $ \alpha: C(B, A) $. The existence of this pullback makes the functor $ C^2 \to C $ into a fibration.

Now, in $ \SET $, for a family $ (X_a)_a $, consider the dependent product $ \prod_{a : A} X_a $. Its elements $ (x_a)_a $ can be identified with morphisms from the terminal set: $ \{ \star \} \to \prod_{a : A} X_a $, sending $ \star $ to $ (x_a)_a $. However, they can also be identified with the morphisms $ \varphi: A \to \sum_{a : A} X_a $ that make the following diagram commute, sending $ a $ to $ x_a $:
\begin{center}
  \begin{tikzcd}
    A \arrow[rd, "\id A"] \arrow[rr, " \varphi "] & & \sum_{a : A} X_a \arrow[ld, "f"]\\
    & A
  \end{tikzcd}
\end{center}
These are morphisms in $ (\SET \downarrow A) $ from $ (A, \id A) $ to $ (\sum_{a : A} X_a, f) $. Note that for the terminal morphism $ \alpha: A \to \{ \star \} $, we have $ \id A = \alpha^*(\id{\{\star\}}) $. To summarize, we have an equivalence
\[ (\SET \downarrow A)(\alpha^*(\id{\{\star\}}), f) \simeq (\SET \downarrow {\{\star\}})( \id{\{ \star \}}, \prod_{a : A} X_a). \]
Now, given a family of families $ ((X_b)_{b : B_a})_{a : A} $, we can wonder whether we can construct the family of dependent products $ (\prod_{b : B_a} X_b)_a $. In $ \SET $, this is definitely possible, and from this, we get an equivalence again
\[ (\SET \downarrow (\sum_{a : A} B_a))(\alpha^*(\id A), f) \simeq (\SET \downarrow A)(\id A, (\prod_{b : B_a} X_b)_a). \]
These equivalences suggest an adjunction $ \alpha^* \dashv \prod_{\dots} $. We can use this to define in general
\begin{definition}
  For a category $ C $ and a morphism $ \alpha: B \to A $, the \iindex{dependent product} along $ \alpha $ is, if it exists, the right adjoint to the pullback functor:
  \begin{center}
    \begin{tikzcd}
      (C \downarrow A) \arrow[r, shift left=2, "\alpha^*"{name=A}] &
      (C \downarrow B) \arrow[l, shift left=2, "\prod_\alpha"{name=B}]
      \ar[from=A, to=B, symbol=\dashv]
    \end{tikzcd}
  \end{center}
\end{definition}
\begin{remark}
  As argued above, we can recover the familiar dependent product $ \prod_{a : A} X_a $ of a family $ (X_a)_a $ as the dependent product $ \prod_\alpha f $ along the terminal morphism $ \alpha: A \to I $, with $ f: \sum_a X_a \to A $ the internal representation of the family. Here we use the equivalence between $ (C \downarrow I) $ and $ C $.
\end{remark}

Now we turn our attention to dependent sums. In $ \SET $, let $ (X_a)_a $ and $ (B_a)_a $ be two families over $ A $ and let $ ((Y_b)_{b : B_a})_{a : A} $ be a family of families. Let $ \alpha: \sum_{a : A} B_a \to A $ be the internal representation of $ (B_a)_a $. A family of maps $ f_a : (\sum_{b : B_a} Y_b)_a \to X_a $ consists of maps $ Y_b \to X_a $ for all $ b : B_a $, so these are maps $ f_b : Y_b \to X_{\alpha(b)} $. This gives an equivalence
\[ (\SET \downarrow A)((\sum_{b : B_a} Y_b)_a, (X_a)_a) \simeq (\SET \downarrow (\sum_{a : A} B_a))((Y_b)_b, \alpha^*((X_a)_a)). \]
This, again, suggests an adjunction which we will use as a definition.
\begin{definition}
  For a category $ C $ and a morphism $ \alpha: B \to A $, the \iindex{dependent sum} along $ \alpha $ is, if it exists, the left adjoint to the pullback functor:
  \begin{center}
    \begin{tikzcd}
      (C \downarrow A) \arrow[r, shift right=2, "\alpha^*"'{name=B}] &
      (C \downarrow B) \arrow[l, shift right=2, "\sum_\alpha"'{name=A}]
      \ar[from=A, to=B, symbol=\dashv]
    \end{tikzcd}
  \end{center}
\end{definition}

However, note that the conversion from an external to an internal representation in $ \SET $ already contained a dependent sum, which is no coincidence. It turns out that in practice, we will never have a hard time obtaining dependent sums:
\begin{lemma}\label{lem:sum-postcomposition}
  Let $ \alpha : C(B, A) $ be a morphism in a category. If the pullback functor $ \alpha^*: (C \downarrow A) \to (C \downarrow B) $ exists, it has a left adjoint given by postcomposition with $ \alpha $.
\end{lemma}
\begin{proof}
  For morphisms $ f: X \to A $, $ g: Y \to B $, the universal property of the pullback, with the following diagram
  \begin{center}
    \begin{tikzcd}
      Y \arrow[r, dashed, "\varphi"'] \arrow[rr, "\psi", bend left] \arrow[dr, "g"'] & \alpha^* X \arrow[d, "\alpha^* f"'] \arrow[r] \arrow[rd, phantom, "\lrcorner", very near start] & X \arrow[d, "f"]\\
      & B \arrow[r, "\alpha"'] & A
    \end{tikzcd}
  \end{center}
  gives an equivalence between morphisms $ \varphi: Y \to \alpha^* X $ that commute with $ g $ and $ \alpha^* f $, and morphisms $ \psi: Y \to X $ that commute with $ g $, $ f $ and $ \alpha $. In other words:
  \[ (C \downarrow A)(g \cdot \alpha, f) \simeq (C \downarrow B)(g, \alpha^*(f)), \]
  which shows the adjunction.
\end{proof}

Now, let $ f : X \to A $ be the internal representation of an indexed family $ (X_a)_a $ and let $ \alpha : A \to I $ be the terminal projection. We have $ \sum_{a : A} X_a = f \circ \alpha : X \to I $. By the equivalence between $ (C \downarrow I) $ and $ C $, we see that the dependent sum of the family $ (X_a)_a $ is exactly $ X $. Therefore, our attention is mainly focused on the dependent product.

We will close this section with a name for a category that has all dependent products:

\begin{definition}
  A \index{cartesian closed!locally}\textit{locally cartesian closed} category is a category $ C $ with pullbacks such that each pullback functor $ \alpha^* $ has a right adjoint.
\end{definition}

Apart from having dependent sums and products, there also is the following theorem that shows the significance of locally cartesian closedness:
\begin{lemma}\label{lem:locally-cartesian-closed}
  A category $ C $ is locally cartesian closed iff $ (C \downarrow A) $ is cartesian closed for each $ A : C $.
\end{lemma}
\begin{proof}
  See the end of Section 1.3 of \autocite{freyd}.
\end{proof}

\begin{remark}\label{rem:pullback-of-projection}
  Note that for $ X, Y, Z : C $ and $ f: C(Y, X) $, the following diagram shows that $ f^* \Delta_X Z \cong \Delta_Y Z $:
  \begin{center}
    \begin{tikzcd}
      Y \times Z \arrow[d, "p_1"] \arrow[r, "f \times \id Z"] & X \times Z \arrow[d, "p_1"] \arrow[r, "p_2"] & Z \arrow[d, "!"]\\
      Y \arrow[r, "f"] & X \arrow [r, "!"] & T
    \end{tikzcd}
  \end{center}
\end{remark}

\begin{lemma}\label{lem:constant-dependent-product}
  For $ W, X, Z : C $ and $ p_1 : X \times Z \to X $,
  \[ \prod_{p_1} \Delta_{X \times Z} W \cong \Delta_X W^Z \]
\end{lemma}
\begin{proof}
  First of all, note that $ (C \downarrow X \times Z) \cong ((C \downarrow X) \downarrow \Delta_X Z) $. Also note that the composite morphism $ (X \times Z) \times W \xrightarrow{p_1} X \times Z \xrightarrow{p_1} X $ is the element $ \Delta_X (W \times Z) : (C \downarrow X) $.

  By Proposition 1.34 in \autocite{freyd}, $ \prod_{p_1} \Delta_{X \times Z} W $ is given as the following pullback:
  \begin{center}
    \begin{tikzcd}
      \prod_{p_1} \Delta_{X \times Z} W \arrow[r] \arrow[d] & (\Delta_X Z \times W)^{\Delta_X Z} \arrow[d, "(\Delta_X p_1)^{\Delta_X Z}"]\\
      X \arrow[r] & (\Delta_X Z)^{\Delta_X Z}
    \end{tikzcd}
  \end{center}

  By Lemma \ref{lem:delta-exponentials}, $ \Delta_X $ preserves exponential objects, so the morphism on the right is $ \Delta_X p_1^Z : (C \downarrow X)(\Delta_X (Z \times W)^Z, \Delta_X Z^Z) $. However, we have an isomorphism $ (Z \times W)^Z \cong Z^Z \times Z^W $, and then the morphism on the right becomes
  \[ \Delta_X p_1 : (C \downarrow X)(\Delta_X(Z^Z \times Z^W), \Delta_X Z^Z) \]
  We also have an isomorphism $ X \cong \Delta_X T $. Then by Lemma \ref{lem:delta-limits} and Remark \ref{rem:pullback-of-projection}, the pullback of this diagram is $ \Delta_X W^Z $:
  \begin{center}
    \begin{tikzcd}
      \Delta_X W^Z \arrow[r] \arrow[d] & \Delta_X (Z^Z \times W^Z) \arrow[d, "\Delta_X p_1"]\\
      \Delta_X T \arrow[r] & \Delta_X Z^Z
    \end{tikzcd}
  \end{center}
\end{proof}


\section{(Weakly) terminal objects}
\begin{definition}
  If a category has an object $ t $, such that there is a (not necessarily unique) morphism to it from every other object in the category, $ t $ is said to be a \iindex{weakly terminal object}.
\end{definition}

\begin{definition}
  Let $ C $ be a category with terminal object $ t $. For an object $ c: C $, a \iindex{global element} of $ c $ is a morphism $ f: C(t, c) $.
\end{definition}


\section{Kan Extensions}
One of the most general and abstract concepts in category theory is the concept of \textit{Kan extensions}. In \autocite{MacLane}, Section X.7, MacLane notes that

\enquote{The notion of Kan extensions subsumes all the other fundamental concepts of category theory.}

In this thesis, we will use left Kan extension a handful of times. It comes in handy when we want to extend a functor along another functor in the following way:

Let $ A $, $ B $ and $ C $ be categories and let $ F : A \to B $ be a functor.
\begin{definition}
  Precomposition gives a functor between functor categories $ F_* : [B, C] \to [A, C] $. If $ F_* $ has a left adjoint, we will denote call this adjoint functor the \textit{left Kan extension}\index{Kan extension!left} along $ F $ and denote it $ \mathrm{Lan}_F : [A, C] \to [B, C] $.

  \begin{center}
    \begin{tikzcd}
      A \arrow[rr, "F"] \arrow[rd, dashed, "F_* G"'] & & B \arrow[ld, "G"]\\
      & C
    \end{tikzcd}
    \qquad
    \begin{tikzcd}
      A \arrow[rr, "F"] \arrow[rd, "G"'] & & B \arrow[ld, dashed, "\Lan F G"]\\
      & C
    \end{tikzcd}
  \end{center}

  Analogously, when $ F_* $ has a right adjoint, one calls this the \textit{right Kan extension}\index{Kan extension!right} along $ F $ and denote it $ \mathrm{Ran}_F: [A, C] \to [B, C] $.
\end{definition}

If a category has limits (resp. colimits), we can construct the right (resp. left) Kan extension in a `pointwise' fashion (see Theorem X.3.1 in \autocite{MacLane} or Theorem 2.3.3 in \autocite{Kashiwara}). Below, I will outline the parts of the construction that we will need explicitly in this thesis.
\begin{lemma}
  If $ C $ has colimits, $ \Lan F {} $ exists.
\end{lemma}
\begin{proof}
  First of all, for objects $ b: B $, we take
  \[ \Lan F G(b) := \text{colim} \left( (F \downarrow b) \to A \xrightarrow G C \right). \]

  Here, $ (F \downarrow b) $ denotes the comma category with as objects the morphisms $ B(F(a), b) $ for all $ a: A $, and as morphisms from $ f: B(F(a), b) $ to $ f^\prime: B(F(a^\prime), b) $ the morphisms $ g: A(a, a^\prime) $ that make the diagram commute:
  \begin{center}
    \begin{tikzcd}
      F(a) \arrow[rr, "F(g)"] \arrow[rd, "f"'] & & F(a^\prime) \arrow[ld, "f^\prime"]\\
      & b
    \end{tikzcd}
  \end{center}
  and $ (F \downarrow b) \to A $ denotes the projection functor that sends $ f: B(F(a_1), b) $ to $ a_1 $.

  Now, a morphism $ h: B(b, b^\prime) $ gives a morphism of diagrams, sending the $ F(a) $ corresponding to $ f: B(G(a), b) $ to the $ F(a) $ corresponding to $ f \cdot h: B(G(a), b^\prime) $. From this, we get a morphism $ \Lan F G(h): C(\Lan F G(b), \Lan F G(b^\prime)) $.

  The unit of the adjunction is a natural transformation $ \eta: \id{[A, C]} \Rightarrow \Lan F {} \bullet F_* $. We will define this pointwise, for $ G: [A, C] $ and $ a: A $. Our diagram contains the $ G(a) $ corresponding to $ \id{F(a)}: (F \downarrow F(a)) $ and the colimit cocone gives a morphism
  \[ \eta_G(a) : C(G(a), \Lan F G (F(a))), \]
  the latter being equal to $ (\Lan F {} \bullet F_*)(G)(a) $.

  The counit of the adjunction is a natural transformation $ \epsilon: F_* \bullet \Lan F {} \Rightarrow \id{[B, C]} $. We will also define this pointwise, for $ G: [B, C] $ and $ b: B $. The diagram for $ \Lan F (F_* G)(b) $ consists of $ G(F(a)) $ for all $ f: B(F(a), b) $. Then, by the universal property of the colimit, the morphisms $ G(f): C(G(F(a)), G(b)) $ induce a morphism
  \[ \epsilon_G(b) : C(\Lan F (F_* G)(b), G(b)). \]
\end{proof}

\begin{lemma}\label{lem:lan-precomp-iso}
  If $ F : A \to B $ is a fully faithful functor, and $ C $ is a category with colimits, $ \eta: \id{[A, C]} \Rightarrow \Lan F {} \bullet F_* $ is a natural isomorphism.
\end{lemma}
\begin{proof}
  To show that $ \eta $ is a natural isomorphism, we have to show that $ \eta_G(a^\prime): G(a^\prime) \Rightarrow \Lan F G(F(a^\prime)) $ is an isomorphism for all $ G: [A, C] $ and $ a^\prime: A $. Since a left adjoint is unique up to natural isomorphism (\autocite{CT4P}, Exercise 153), we can assume that $ \Lan F G(F(a^\prime)) $ is given by
  \[ \text{colim} ((F \downarrow F(a^\prime)) \to A \xrightarrow G C). \]
  Now, the diagram for this colimit consists of $ G(a) $ for each arrow $ f: B(F(a), F(a^\prime)) $. Since $ F $ is fully faithful, we have $ f = F(\overline f) $ for some $ \overline f: A(a, a^\prime) $. If we now take the arrows $ G(\overline f): C(G(a), G(a^\prime)) $, the universal property of the colimit gives an arrow
  \[ \varphi: C(\Lan F G(F(a^\prime)), G(a^\prime)) \]
  which constitutes an inverse to $ \eta_G(a^\prime) $. The proof of this revolves around properties of the colimit and its (induced) morphisms.
\end{proof}

\begin{remark}
  In the same way, if $ C $ has limits, $ \epsilon $ is a natural isomorphism.
\end{remark}

\begin{corollary}\label{cor:surjective-precomposition}
  If $ C $ has limits or colimits, precomposition of functors $ [B, C] $ along a fully faithful functor is (split) essentially surjective.
\end{corollary}
\begin{proof}
  For each $ G: [A, C] $ we take $ \Lan F G: [B, C] $, and we have $ F_*(\Lan F G) \cong G $.
\end{proof}

\begin{corollary}
  If $ C $ has colimits (resp. limits), left (resp. right) Kan extension of functors $ [A, C] $ along a fully faithful functor is fully faithful.
\end{corollary}
\begin{proof}
  Since left Kan extension along $ F $ is the left adjoint to precomposition, we have
  \[ [A, C](\Lan F G, \Lan F G^\prime) \cong [B, C](G, F_*(\Lan F G^\prime)) \cong [B, C](G, G^\prime). \]
\end{proof}

\section{Coends}\label{sec:coends}
This section is based on Section 1.2 of \autocite{riehl}.

In this thesis, we will encounter co-ends a couple of times, so we will introduce them here.
\begin{definition}
  Let $ C, D $ be categories and $ F : \op C \times C \to D $ a functor. We define the \iindex{coend} $ \int^{c : C} F(c, c) $ to be the colimit
  \begin{center}
    \begin{tikzcd}
      \displaystyle\coprod_{\substack{f : C(a, b)}} F(b, a)
        \arrow[r, shift left, "{F(f, \id b)}"]
        \arrow[r, shift right, "{F(\id a, f)}"'] &
      \displaystyle\coprod_{c : C} F(c, c)
        \arrow[r, dashed] &
      \int^C F
    \end{tikzcd}
  \end{center}
\end{definition}

\begin{remark}
  An alternative way to phrase this, is that $ \int^C F : D $ is an object, equipped with arrows $ F(c, c) \to \int^C F $ such that for all $ f: C(a, b) $, the following diagram must commute
  \begin{center}
    \begin{tikzcd}
      F(b, a) \arrow[r, "{F(f, \id a)}"] \arrow[d, "{F(\id b, f)}"] & F(a, a) \arrow[d]\\
      F(b, b) \arrow[r] & \int^C F
    \end{tikzcd}
  \end{center}
  and such that for any other $ G : D $ with the same properties, we have a unique morphism $ \int_C F \to G $, making the triangles commute
  \begin{center}
    \begin{tikzcd}
      F(c, c) \arrow[r] \arrow[rd] & \int_C F \arrow[d]\\
      & G
    \end{tikzcd}
  \end{center}
\end{remark}

\begin{remark}
  Of course, a co-end is actually the dual notion of an end, which can be defined as the equalizer of the diagram above, but with the arrows reversed.
\end{remark}

\begin{remark}
  Left Kan extension can be expressed as a coend:
  \[ \Lan F G(b) = \int^{a : A} D(F a, b) \cdot G a \]
  where $ S \cdot X $ for $ S $ a set and $ X : C $ denotes the `copower'. In most cases, we will have
  \[ S \cdot X = \coprod_{s : S} X. \]
\end{remark}

\section{The Karoubi envelope}
Let $ C $ be a category. If we have a retraction-section pair
\begin{tikzcd}
  c \arrow[r, shift left, "r"] & d \arrow[l, shift left, "s"]
\end{tikzcd}
we have (by definition) $ s \cdot r = \id d $. On the other hand, $ r \cdot s: c \to c $ is an idempotent morphism, since $ r \cdot s \cdot r \cdot s = r \cdot s $. Conversely, we can wonder whether for some idempotent morphism $ a: c \to c $, we can find a retraction-section pair $ (r, s) $ such that $ a = r \cdot s $. If this is the case, we say that the idempotent $ a $ \textit{splits}\index{split idempotent}. If $ a $ does not split, we can wonder whether we can find an embedding $ \iota_C : C \hookrightarrow \overline C $ such that the idempotent $ \iota_C(a): \iota_C(c) \to \iota_C(c) $ does split. This is one way to arrive at the \textit{Karoubi envelope}.

\begin{definition}
  We define the category $ \overline C $. The objects of $ \overline C $ are tuples $ (c, a) $ with $ c: C $, $ a: C(c, c) $ such that $ a \cdot a = a $. The morphisms between $ (c, a) $ and $ (d, b) $ are morphisms $ f: C(a, b) $ such that $ a \cdot f \cdot b = f $. The identity morphism on $ (c, a) $ is given by $ a $ and $ \overline C $ inherits morphism composition from $ C $.
\end{definition}
This category is called the \iindex{Karoubi envelope}, the \textit{idempotent completion}\index{idempotent completion|see{Karoubi envelope}}, the \textit{category of retracts}\index{category of retracts|see{Karoubi envelope}}, or the \textit{Cauchy completion}\index{Cauchy completion|see{Karoubi envelope}} of $ C $.

\begin{remark}
  Note that for a morphism $ f: \overline C((c, a), (d, b)) $,
  \[ a \cdot f = a \cdot a \cdot f \cdot b = a \cdot f \cdot b = f \]
  and in the same way, $ f \cdot b = f $.
\end{remark}

\begin{definition}
  We have an embedding $ \iota_C: C \to \overline C $, sending $ c: C $ to $ (c, \id{c}) $ and $ f: C(c, d) $ to $ f $.
\end{definition}

\begin{lemma}\label{lem:karoubi-is-retract}
  Every object $ c: \overline C $ is a retract of $ \iota_C(c_0) $ for some $ c_0: C $.
\end{lemma}
\begin{proof}
  Note that $ c = (c_0, a) $ for some $ c_0: C $ and an idempotent $ a: c \to c $. We have morphisms
  \begin{tikzcd}
    \iota_C(c) \arrow[r, shift left, "a_\rightarrow"] & (c, a) \arrow[l, shift left, "a_\leftarrow"]
  \end{tikzcd}, both given by $ a $. We have $ a_\leftarrow \cdot a_\rightarrow = a = \id{(c, a)} $, so $ (c, a) $ is a retract of $ \iota_C(c) $.
\end{proof}

\begin{lemma}
  In $ \overline C $, every idempotent splits.
\end{lemma}
\begin{proof}
  Take an idempotent $ e: \overline C(c, c) $. Note that $ c $ is given by an object $ c_0: C $ and an idempotent $ a: C(c_0, c_0) $. Also, $ e $ is given by some idempotent $ e: C(c_0, c_0) $ with $ a \cdot e \cdot a = e $.

  Now, we have $ (c_0, e): \overline C $ and morphisms
  \begin{tikzcd}
    (c_0, a) \arrow[r, shift left, "e_\rightarrow"] & (c_0, e) \arrow[l, shift left, "e_\leftarrow"]
  \end{tikzcd}, both given by $ e $. We have $ e_\leftarrow \cdot e_\rightarrow = e = \id{(c_0, e)} $, so $ (c_0, e) $ is a retract of $ (c_0, a) $. Also, $ e = e_\rightarrow \cdot e_\leftarrow $, so $ e $ is split.
\end{proof}

\begin{remark}
  Note that the embedding is fully faithful, since
  \[ \overline C((c, \id c), (d, \id d)) = \{ f: C(c, d) \mid \id c \cdot f \cdot \id d = f \} = C(c, d). \]
\end{remark}

\begin{remark}\label{rem:retract-coequalizer}
  Let $ D $ be a category. Suppose that we have a retraction-section pair in $ D $, given by
  \begin{tikzcd}
    d \arrow[r, shift left, "r"] & d^\prime \arrow[l, shift left, "s"]
  \end{tikzcd}.
  Now, suppose that we have an object $ c: D $ and a morphism $ f $ with $ (r \cdot s) \cdot f = f $. Then we get a morphism $ s \cdot f: d^\prime \to c $ such that $ f $ factors as $ r \cdot (s \cdot f) $. Also, for any $ g $ with $ r \cdot g = f $, we have
  \[ g = s \cdot r \cdot g = s \cdot f. \]
  \begin{center}
    \begin{tikzcd}
      d \arrow[r, left, "r"] \arrow[rd, "f"'] & d^\prime \arrow[r, "s"] \arrow[d, "s \cdot f" description] & d \arrow[ld, "f"]\\
      & c
    \end{tikzcd}.
  \end{center}
  Therefore, $ d^\prime $ is the equalizer of \begin{tikzcd}
    d \arrow[r, shift left, "\id d"] \arrow[r, shift right, "r \cdot s"'] & d
  \end{tikzcd}. In the same way, it is also the coequalizer of this diagram.

  Now, note that if we have a coequalizer $ c^\prime $ of $ \id c $ and $ a $, and an equalizer $ d^\prime $ of $ \id d $ and $ b $, the universal properties of these give an equivalence
  \[ D(c^\prime, d^\prime) \cong \{ f: D(c, d^\prime) \mid a \cdot f = f \} \cong \{ f: D(c, d) \mid a \cdot f = f = f \cdot b \}. \]
  \begin{center}
    \begin{tikzcd}
      c \arrow[r, shift left, "\id c"] \arrow[r, shift right, "a"'] & c \arrow[r] \arrow[d] \arrow[rd] & c^\prime \arrow[d]\\
      d & d \arrow[l, shift right, "\id d"'] \arrow[l, shift left, "b"] & d^\prime \arrow[l]
    \end{tikzcd}
  \end{center}
\end{remark}

Since a functor preserves retracts, and since every object of $ \overline C $ is a retract of an object in $ C $, one can lift a functor from $ C $ (to a category with (co)equalizers) to a functor on $ \overline C $.

For convenience, the lemma below works with pointwise left Kan extension using colimits, but one could also prove this using just (co)equalizers (or right Kan extension using limits).
\begin{lemma}
  Let $ D $ be a category with colimits. We have an adjoint equivalence between $ [C, D] $ and $ [\overline C, D] $.
\end{lemma}
\begin{proof}
  We already have an adjunction $ \Lan {\iota_C} {} \dashv \iota_{C*} $. Also, since $ \iota_C $ is fully faithful, we know that $ \eta $ is a natural isomorphism. Therefore, we only have to show that $ \epsilon $ is a natural isomorphism. That is, we need to show that $ \epsilon_G(c, a): D(\Lan {\iota_C} (\iota_{C*} G) (c, a), G(c, a)) $ is an isomorphism for all $ G: [\overline C, D] $ and $ (c, a): \overline C $.

  One of the components in the diagram of $ \Lan {\iota_C} (\iota_{C*} G) (c, a) $ is the $ \iota_{C*} G(c) = G(c, \id c) $ corresponding to $ a: \iota_C(c) \to (c, a) $. This component has a morphism into our colimit
  \[ \varphi: C(G(\iota_C(c)), \Lan {\iota_C} (\iota_{C*} G) (c, a)). \]
  Note that we can view $ a $ as a morphism $ a: \overline C((c, a), \iota_C(c)) $. This gives us our inverse morphism
  \[ G(a) \cdot \varphi: C(G(c, a), \Lan {\iota_C} (\iota_{C*} G) (c, a)). \]
\end{proof}

\begin{lemma}
  The formation of the opposite category commutes with the formation of the Karoubi envelope.
\end{lemma}
\begin{proof}
  An object in $ \overline{\op C} $ is an object $ c: \op C $ (which is just an object $ c: C $), together with an idempotent morphism $ a: \op C(c, c) = C(c, c) $. This is the same as an object in $ \op{\overline C} $.

  A morphism in $ \overline{\op C}((c, a), (d, b)) $ is a morphism $ f: \op C(c, d) = C(d, c) $ such that
  \[ b \cdot_C f \cdot_C a = a \cdot_{\op C} f \cdot_{\op C} b = f. \]
  A morphism in $ \op{\overline C}((c, a), (d, b)) = \overline C((d, b), (c, a)) $ is a morphism $ f: C(d, c) $ such that $ b \cdot f \cdot a = f $.

  Now, in both categories, the identity morphism on $ (c, a) $ is given by $ a $.

  Lastly, $ \overline {\op C} $ inherits morphism composition from $ \op C $, which is the opposite of composition in $ C $. On the other hand, composition in $ \op{\overline C} $ is the opposite of composition in $ \overline C $, which inherits composition from $ C $.
\end{proof}

\begin{corollary}\label{cor:karoubi-presheaf}
  As the category $ \SET $ is cocomplete, we have an equivalence between the category of presheaves on $ C $ and the category of presheaves on $ \overline C $:
  \[ [\op C, \SET] \cong [\overline{\op C}, \SET] \cong [\op{\overline C}, \SET]. \]
\end{corollary}

Now, there is also another (classically equivalent) definition of the Karoubi envelope:
\begin{definition}\label{def:karoubi'}
  Let $ Y: C \to P C $ be the Yoneda embedding of $ C $ into its category of presheaves. We define the category $ \hat C $ as the full subcategory of $ P C $ consisting of objects $ F : P C $ such that there exists an object $ c: C $ and a retraction of $ Y(c) $ onto $ F $. Note that the existence of $ c $ and the retraction is \textit{mere existence} (see the chapter on Univalent Foundations) because we need this to be a subcategory of $ P C $.
\end{definition}

\begin{lemma}\label{lem:retracts-rezk}
  $ \hat C $ is the Rezk completion of $ \overline C $.
\end{lemma}
\begin{proof}
  First of all, note that $ \hat C $ is univalent, since it is a presheaf category (see Theorem 4.5 in \autocite{univalent-categories}). So we must show that we have a weak equivalence from $ \overline C $ to $ \hat C $.

  Secondly, by Corollary \ref{cor:karoubi-presheaf} we have an adjoint equivalence $ {\op{\iota_C}}_*: P \overline C \xrightarrow \sim P C $ and by Lemma \ref{lem:Yoneda-restriction-commutes}, the following diagram 2-commutes:
  \begin{center}
    \begin{tikzcd}
      C \arrow[r, "\iota_C"] \arrow[d, "Y"] & \overline C \arrow[d, "Y"]\\
      P C & P \overline C \arrow[l, "\sim"', "{\op{\iota_C}}_*"]
    \end{tikzcd}
  \end{center}

  By Lemma \ref{lem:karoubi-is-retract}, every object of $ \overline C $ is a retract of some object in $ c $. Therefore, every object in the image of $ \overline C $ inside $ P C $ is a retract of some object in the image of $ C $, so we can turn $ Y \bullet {\op{\iota_C}}_* : \overline C \to P C $ into a fully faithful embedding into $ \hat C $.

  Now, to show that it is essentially surjective, take an object $ F : \hat C $. That is, take a retract \begin{tikzcd} F \arrow[r, shift left, "s"] & Y(c) \arrow[l, shift left, "r"] \end{tikzcd}. Note that $ r \cdot s $ is an idempotent on $ Y(c) $. Since $ Y $ is a fully faithful embedding, it gives an equivalence on the hom-sets, so we have an element $ e : C(c, c) $ that maps to $ r \cdot s : P C (Y(c), Y(c)) $. We will show that $ (c, e) $ is our preimage in $ \overline C $ of $ F $.

  Also, $ (c, e) $ is a retract of $ \iota_C(c) $ with section and retraction $ e $. Therefore, $ \op{\iota_C} \bullet Y(c, e) $ is a retract of $ \op{\iota_C} \bullet Y (\iota_C (c)) $ with section and retraction $ \op{\iota_C} \bullet Y(e) $. Composing these gives an idempotent
  \[ \op{\iota_C} \bullet Y(e): d \mapsto f \mapsto f \cdot e \]
  on $ \op{\iota_C} \bullet Y (\iota_C (c)) $. Transporting this along the isomorphism with $ Y(c) $, we get an idempotent
  \[ d \mapsto f \mapsto \iota_C^{-1}(\iota_C(f) \cdot e) \]
  on $ Y(c) $. Note that we can view $ e $ both as an idempotent on $ c $ and on $ \iota_C(e) $, and that $ \iota_C(e) = e $, so $ \iota_C^{-1}(\iota_C(f) \cdot e) = f \cdot e $.

  Therefore, the idempotent on $ Y(c) $ is exactly $ Y(e) = r \cdot s $. By Remark \ref{rem:retract-coequalizer}, $ \op{\iota_C} \bullet Y(c, e) $ is the equalizer of $ \id{Y(c)} $ and $ r \cdot s $. Note that by the same remark, $ F $ is the equalizer of $ \id{Y(c)} $ and $ r \cdot s $ as well. Since the equalizer is unique up to unique isomorphism, we have an isomorphism $ F \cong \op{\iota_C} \bullet Y(c, e) $ and we see that $ Y \bullet {\op{\iota_C}}_* $ is essentially surjective.
\end{proof}

\begin{remark}
  As shown above, $ \overline C $ and $ \hat C $ have a very strong relation. In classical mathematics, they are even equivalent. However, since $ \overline C $ is not univalent, we do not have a full equivalence in univalent foundations and our choice of definition will have consequences. One one hand, $ \hat C $ is univalent. On the other hand, every object of $ \overline C $ is uniquely associated with one idempotent morphism in $ C $.

  In this thesis, I will choose to interpret the `category of retracts' or `Karoubi envelope' to mean $ \overline C $. This is because Dana Scott and Paul Taylor perform most of their constructions explicitly using the (idempotent) morphisms of $ C $, which is closest to working in $ \overline C $.

  It is however very well possible that most of the proofs can be made to work in $ \hat C $ as well. For future research, it would be interesting to see what the differences are between working in $ \overline C $ and $ \hat C $ for these proofs.
\end{remark}

\section{Monoids as categories}\label{sec:monoid-category}
Take a monoid $ M $.
\begin{definition}
  We can construct a category $ C_M $ with $ C_{M0} = \{ \star \} $, $ C_M(\star, \star) = M $. The identity morphism on $ \star $ is the identity $ 1: M $. The composition is given by multiplication $ g \cdot_{C_M} f = f \cdot_M g $.
\end{definition}

\begin{remark}
  Actually, we have a functor from the category of monoids to the category of setcategories (categories whose object type is a set).

  A monoid morphism $ f: M \to M^\prime $ is equivalent to a functor $ F_f: C_M \to C_{M^\prime} $. Any functor between $ C_M $ and $ C_{M^\prime} $ sends $ \star_M $ to $ \star_{M^\prime} $. The monoid morphism manifests as $ F_f(m) = f(m) $ for $ m: C_M(\star, \star) = M $.
\end{remark}

\begin{lemma}
  An isomorphism of monoids gives an (adjoint) equivalence of categories.
\end{lemma}
\begin{proof}
  Given an isomorphism $ f: M \to M^\prime $. Then we have functors $ F_f: C_M \to C_{M^\prime} $ and $ F_{f^{-1}}: C_{M^\prime} \to C_M $. Take the identity natural transformations $ \eta: \id{C_M} \Rightarrow F_f \bullet F_{f^{-1}} $ and $ \epsilon: F_{f^{-1}} \bullet F_f \Rightarrow \id{C_{M^\prime}} $. Of course these are natural isomorphisms.
\end{proof}

\begin{definition}
  A \textit{right monoid action}\index{monoid action} of $ M $ on a set $ X $ is a function $ X \times M \to X $ such that for all $ x: X $, $ m, m^\prime: M $,
  \[ x 1 = x \qquad \text{and} \qquad (x m) m^\prime = x (m \cdot m^\prime). \]
\end{definition}

\begin{definition}
  A \textit{morphism}\index{monoid action!morphism} between sets $ X $ and $ Y $ with a right $ M $-action is an $ M $-equivariant function $ f: X \to Y $: a function such that $ f(xm) = f(x)m $ for all $ x: X $ and $ m: M $.
\end{definition}

These, together with the identity and composition from $ \SET $, constitute a category \iindex{$ \RAct M $} of right $ M $-actions.

\begin{lemma}
  Presheaves on $ C_M $ are equivalent to sets with a right $ M $-action.
\end{lemma}
\begin{proof}
  This correspondence sends a presheaf $ F $ to the set $ F(\star) $, and conversely, the set $ X $ to the presheaf $ F $ given by $ F(\star) := X $. The $ M $-action corresponds to the presheaf acting on morphisms as $ xm = F(m)(x) $. A morphism (natural transformation) between presheaves $ F \Rightarrow G $ corresponds to a function $ F(\star) \to G(\star) $ that is $ M $-equivariant, which is exactly a monoid action morphism.
\end{proof}

\begin{remark}
  Since the category of sets with an $ M $-action is equivalent to a presheaf category, it has all limits. However, we can make this concrete. The set of the product $ \prod_i X_i $ is the product of the underlying sets. The action is given pointwise by $ (x_i)_i m = (x_i m)_i $.
\end{remark}

Note that the initial set with $ M $-action is $ \{ \star \} $, with action $ \star m = \star $.

\begin{lemma}\label{lem:global-action-elements}
  The global elements of a set with right $ M $-action correspond to the elements that are invariant under the $ M $-action.
\end{lemma}
\begin{proof}
  A global element of $ X $ is a morphism $ \varphi: \{ \star \} \to X $ such that for all $ m: M $, $ \varphi(\star)m = \varphi(\star m) = \varphi(\star) $. Therefore, it is given precisely by the element $ \varphi(\star): X $, which must be invariant under the $ M $-action.
\end{proof}

\begin{lemma}
  The category $ C $ of sets with an $ M $-action has exponentials.
\end{lemma}
\begin{proof}
  Given sets with $ M $-action $ X $ and $ Y $. Consider the set $ C(M \times X, Y) $ with an $ M $-action given by $ \phi m^\prime(m, x) = \phi(m^\prime m, x) $. This is the exponential object $ X^Y $, with the (universal) evaluation morphism $ X \times X^Y \to Y $ given by $ (x, \phi) \mapsto \phi(1, x) $. Explicitly, we get a natural isomorphism $ \psi: \RAct M(Z \times Y, X) \xrightarrow \sim \RAct M(Z, X^Y) $ given by
  \[ \psi(f)(z)(m, y) = f(z m, y) \quad \text{and} \quad \psi^{-1}(g)(z, y) = g(z)(1, y). \]
\end{proof}

\begin{definition}
  We can view $ M $ as a set $ U_M $ with right $ M $-action $ m n = m \cdot_M n $ for $ m: U_M $ and $ n: M $.
\end{definition}

\subsection{Extension and restriction of scalars}

Let $ \varphi: M \to M^\prime $ be a morphism of monoids.

Remember that sets with a right monoid action are equivalent to presheaves on the monoid category. Also, $ \varphi $ is equivalent to a functor between the monoid categories. The following is a specific case of the concepts in the section about Kan extension:

\begin{lemma}
  We get a \iindex{restriction of scalars} functor $ \varphi^* $ from sets with a right $ M^\prime $-action to sets with a right $ M $-action.
\end{lemma}
\begin{proof}
  Given a set $ X $ with right $ M^\prime $-action, take the set $ X $ again, and give it a right $ M $-action, sending $ (x, m) $ to $ x \varphi(m) $.

  On morphisms, send an $ M^\prime $-equivariant morphism $ f: X \to X^\prime $ to the $ M $-equivariant morphism $ f: X \to X^\prime $.
\end{proof}

Since $ \SET $ has colimits, and restriction of scalars corresponds to precomposition of presheaves (on $ C_{M^\prime} $), we can give it a left adjoint. This is the (pointwise) left Kan extension, which boils down to a very concrete definition, reminiscent of a tensor product:

\begin{lemma}\label{lem:scalar-extension}
  We get an \iindex{extension of scalars} functor $ \varphi_* $ from sets with a right $ M $-action to sets with a right $ M^\prime $-action.
\end{lemma}
\begin{proof}
  Given a set $ X $ with right $ M $-action. Take $ Y = X \times M^\prime / \sim $ with the relation $ (x m, m^\prime) \sim (x, f(m) \cdot m^\prime) $ for $ m: M $. This has a right $ M^\prime $-action given by $ (x, m^\prime)n^\prime = (x, m^\prime n^\prime) $.

  On morphisms, it sends the $ m $-equivariant $ f: X \to X^\prime $ to the morphism $ (x, m^\prime) \mapsto (f(x), m^\prime) $.
\end{proof}

\begin{lemma}\label{lem:scalar-extension-monoid-monoid-action}
  For $ U_M $ the set $ M $ with right $ M $-action, we have $ \varphi_*(U_M) \cong U_{M^\prime} $.
\end{lemma}
\begin{proof}
  The proof relies on the fact that for all $ m: U_M $ and $ m^\prime : M^\prime $, we have
  \[ (m, m^\prime) \sim (1, \varphi(m) m^\prime). \]
\end{proof}

Consider the category $ D $ with $ D_0 = M^\prime $ and
\[ D(m^\prime, \overline m^\prime) = \{ m: M \mid \varphi(m) \cdot m^\prime = \overline m^\prime \}. \]

\begin{lemma}\label{lem:scalar-extension-terminal}
  Suppose that $ D $ has a weakly terminal element. Then for $ I_M $ the terminal object in the category of sets with a right $ M $-action, we have $ \varphi_*(I_M) \cong I_{M^\prime} $.
\end{lemma}
\begin{proof}
  If $ D $ has a weakly terminal object, there exists $ m_0 : M^\prime $ such that for all $ m^\prime: M^\prime $, there exists $ m: M $ such that $ \varphi(m) \cdot m^\prime = m_0 $.

  The proof relies on the fact that every element of $ \varphi_*(I_M) $ is given by some $ (\star, m^\prime) $, but then
  \[ (\star, m^\prime) = (\star \cdot m, m^\prime) \sim (\star, \varphi(m) \cdot m^\prime) = (\star, m_0), \]
  so $ \varphi_*(I_M) $ has exactly $ 1 $ element.
\end{proof}

\begin{remark}
  For $ \varphi_* $ to preserve terminal objects, we actually only need $ D $ to be connected. The fact that $ \varphi_*(I_M) $ is a quotient by a symmetric and transitive relation then allows us to `walk' from any $ (\star, m^\prime_1) $ to any other $ (\star, m^\prime_2) $ in small steps.
\end{remark}

For any $ m^\prime_1, m^\prime_2: M^\prime $, consider the category $ D_{m^\prime_1, m^\prime_2} $, given by
\[ D_{m^\prime_1, m^\prime_2, 0} = \{ (m^\prime, m_1, m_2): M^\prime \times M \times M \mid m_i^\prime = \varphi(m_i) \cdot m^\prime \} \]
and
\[ D_{m^\prime_1, m^\prime_2}((m^\prime, m_1, m_2), (\overline m^\prime, \overline m_1, \overline m_2)) = \{ m: M \mid \varphi(m) \cdot m^\prime = \overline m^\prime, m_i = \overline m_i \cdot m \}. \]

\begin{lemma}\label{lem:scalar-extension-product}
  Suppose that $ D_{m^\prime_1, m^\prime_2} $ has a weakly terminal object for all $ m^\prime_1, m^\prime_2: M^\prime $. Then for sets $ A $ and $ B $ with right $ M $-action, we have $ \varphi_*(A \times B) \cong \varphi_*(A) \times \varphi_*(B) $.
\end{lemma}
\begin{proof}
  Now, any element in $ \varphi_*(A) \times \varphi_*(B) = (A \times M^\prime / \sim) \times (B \times M^\prime / \sim) $ is given by some $ (a, m^\prime_1, b, m^\prime_2) $.

  The fact that $ D_{m^\prime_1, m^\prime_2} $ has a weakly terminal object means that we have some $ \overline m^\prime: M^\prime $ and $ \overline m_1, \overline m_2: M $ with $ m_i^\prime = \varphi(\overline m_i) \cdot \overline m^\prime $. Therefore,
  \[ (a, m^\prime_1, b, m^\prime_2) = (a, \varphi(\overline m_1) \cdot \overline m^\prime, b, \varphi(\overline m_2) \cdot \overline m^\prime) \sim (a \overline m_1, \overline m^\prime, b \overline m_2, \overline m^\prime), \]
  so this is equivalent to some element in $ \varphi_*(A \times B) = (A \times B \times M^\prime / \sim) $. Note that this trivially respects the right $ M^\prime $-action.

  The fact that $ (\overline m^\prime, \overline m_1, \overline m_2) $ is weakly terminal also means that for all $ m^\prime: M^\prime $ and $ m_1, m_2: M $ with $ m_i^\prime = \varphi(m_i) \cdot m^\prime $, there exists $ m: M $ such that $ \varphi(m) \cdot m^\prime = \overline m^\prime $ and $ m_i = \overline m_i \cdot m $. This means that the equivalence that we established is actually well-defined: equivalent elements in $ \varphi_*(A) \times \varphi_*(B) $ are sent to equivalent elements in $ \varphi_*(A \times B) $.

  Therefore, we have an isomorphism $ \psi: \varphi^*(A) \times \varphi^*(B) \xrightarrow{\sim} \varphi^*(A \times B) $. Now we only need to show that the projections are preserved by this isomorphism. To that end, take $ x = (a, m^\prime_1, b, m^\prime_2) \sim (a \overline m_1, \overline m^\prime, b \overline m_2, \overline m^\prime) : \varphi^*(A) \times \varphi^*(B) $. We have
  \[ \varphi^*(\pi_1)(\psi(x)) = (a \overline m_1, \overline m^\prime) = \pi^\prime_1(x). \]
  In the same way, $ \varphi^*(\pi_2) \circ \psi = \pi^\prime_2 $ and this concludes the proof.
\end{proof}
